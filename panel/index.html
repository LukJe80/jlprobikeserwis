<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel serwisanta ‚Äì JL Pro Bike Serwis</title>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #000; padding: 6px 10px; }
    th { background: #eee; }
    button { margin-top: 10px; padding: 6px 12px; }
    select { padding: 4px; }
  </style>
</head>

<body>

<!-- üîê OCHRONA PANELU -->
<script>
  if (localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "/panel/login.html";
  }
</script>

<h1>üõ† Panel serwisanta</h1>
<p>System obs≈Çugi zlece≈Ñ</p>

<button id="logout">üö™ Wyloguj</button>

<hr>

<h2>‚ûï Nowe zlecenie</h2>
<form id="addForm">
  <input id="imie" placeholder="Imiƒô" required />
  <input id="telefon" placeholder="Telefon" required />
  <select id="typ_roweru">
    <option value="">-- typ roweru --</option>
    <option>Miejski</option>
    <option>Szosowy</option>
    <option>MTB</option>
    <option>Gravel</option>
    <option>E-bike</option>
  </select>
  <textarea id="opis" placeholder="Opis usterki" rows="3"></textarea>
  <button type="submit">Dodaj zlecenie</button>
</form>

<hr>

<button id="load">üìã Pobierz zlecenia</button>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Imiƒô</th>
      <th>Telefon</th>
      <th>Rower</th>
      <th>Opis</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="output">
    <tr><td colspan="6">Kliknij ‚ÄûPobierz zlecenia‚Äù</td></tr>
  </tbody>
</table>

<!-- SUPABASE -->
<script type="module" src="/panel/supabaseClient.js"></script>

<script type="module">
  const tbody = document.getElementById("output");
  const loadBtn = document.getElementById("load");
  const form = document.getElementById("addForm");
  const logoutBtn = document.getElementById("logout");

  // üö™ WYLOGOWANIE
  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("loggedIn");
    window.location.href = "/panel/login.html";
  });

  async function loadZlecenia() {
    tbody.innerHTML = `<tr><td colspan="6">‚è≥ ≈Åadowanie...</td></tr>`;

    const { data, error } = await window.supabase
      .from("zlecenia")
      .select("*")
      .order("id", { ascending: false });

    if (error) {
      tbody.innerHTML = `<tr><td colspan="6">‚ùå ${error.message}</td></tr>`;
      return;
    }

    tbody.innerHTML = "";

    data.forEach(z => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${z.id}</td>
        <td>${z.imie ?? ""}</td>
        <td>${z.telefon ?? ""}</td>
        <td>${z.typ_roweru ?? ""}</td>
        <td>${z.opis ?? ""}</td>
        <td>
          <select data-id="${z.id}">
            <option ${z.status==="Rower przyjƒôty do serwisu"?"selected":""}>Rower przyjƒôty do serwisu</option>
            <option ${z.status==="W trakcie naprawy"?"selected":""}>W trakcie naprawy</option>
            <option ${z.status==="Gotowy do odbioru"?"selected":""}>Gotowy do odbioru</option>
            <option ${z.status==="Wydany klientowi"?"selected":""}>Wydany klientowi</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);

      tr.querySelector("select").addEventListener("change", async e => {
        await window.supabase
          .from("zlecenia")
          .update({ status: e.target.value })
          .eq("id", z.id);
      });
    });
  }

  loadBtn.addEventListener("click", loadZlecenia);

  form.addEventListener("submit", async e => {
    e.preventDefault();

    await window.supabase.from("zlecenia").insert({
      imie: imie.value,
      telefon: telefon.value,
      typ_roweru: typ_roweru.value,
      opis: opis.value,
      status: "Rower przyjƒôty do serwisu"
    });

    form.reset();
    loadZlecenia();
  });
</script>

</body>
</html>
