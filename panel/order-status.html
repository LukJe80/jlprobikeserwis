<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Status zlecenia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabaseClient.js"></script>

<style>
  body {
    background:#020617;
    color:#e5e7eb;
    font-family: Arial, sans-serif;
    padding:30px;
    text-align:center;
  }
  .box {
    max-width:520px;
    margin:auto;
    background:rgba(255,255,255,0.05);
    padding:24px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.08);
  }
  h2{ margin:0 0 10px; }
  .status { font-size:22px; font-weight:bold; margin:18px 0 10px; }
  .oczekujące { color:#94a3b8; }
  .nowe { color:#60a5fa; }
  .wtrakcie { color:#f59e0b; }
  .gotowe { color:#22c55e; }
  .wydano { color:#9ca3af; }
  .error { color:#f87171; font-weight:bold; }

  .hint{
    margin-top:14px;
    color:rgba(229,231,235,0.75);
    font-size:13px;
    line-height:1.45;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    margin-top:14px;
    padding:10px 14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.06);
    color:#e5e7eb;
    text-decoration:none;
    font-weight:800;
    cursor:pointer;
  }
  .btn:hover{ border-color: rgba(37,99,235,0.6); }
</style>
</head>

<body>

<div class="box" id="box" style="display:none">
  <h2>Status naprawy</h2>
  <div id="bike"></div>
  <div class="status" id="status"></div>
  <div id="message"></div>

  <div class="hint" id="hint"></div>
  <a class="btn" id="openServiceBtn" href="#" style="display:none;">Otwórz jako serwisant</a>
</div>

<div class="error" id="error">Nie znaleziono zlecenia</div>

<script>
  // ✅ USTAW TO:
  // jeśli Twój plik serwisanta jest gdzie indziej, zmień ścieżkę poniżej
  const SERVICE_PAGE = "/panel/order-local.html"; // np. "/panel/order-local.html" lub "/panel/order-local/index.html"

  const code = new URLSearchParams(location.search).get("code");

  function statusText(s) {
    return {
      "oczekujące": "Zgłoszenie online",
      "nowe": "Rower przyjęty",
      "w trakcie": "Naprawa w toku",
      "gotowe": "Gotowe do odbioru",
      "wydano": "Rower wydany"
    }[s] || s;
  }

  function statusMessage(s) {
    return {
      "oczekujące": "Zgłoszenie zostało wysłane. Przyjedź do serwisu z rowerem.",
      "nowe": "Rower został przyjęty do serwisu.",
      "w trakcie": "Pracujemy nad Twoim rowerem.",
      "gotowe": "Rower jest gotowy do odbioru.",
      "wydano": "Zlecenie zakończone."
    }[s] || "";
  }

  function toClass(s){
    if(s === "w trakcie") return "wtrakcie";
    return s || "";
  }

  async function isServiceLoggedIn(){
    try{
      const { data } = await supabaseClient.auth.getSession();
      return !!(data && data.session);
    }catch(e){
      return false;
    }
  }

  async function loadClientView(){
    if (!code) return;

    const { data } = await supabaseClient
      .from("orders")
      .select("bike_type,status")
      .eq("public_code", code)
      .single();

    if (!data) return;

    box.style.display = "block";
    error.style.display = "none";

    bike.innerText = "Rower: " + (data.bike_type || "-");
    status.innerText = statusText(data.status);

    const cls = toClass(data.status);
    status.className = "status " + cls;

    message.innerText = statusMessage(data.status);
  }

  async function main(){
    if(!code){
      error.textContent = "Brak kodu w linku.";
      return;
    }

    // 1) jeśli serwisant zalogowany → przekieruj
    const logged = await isServiceLoggedIn();

    if(logged){
      const target = `${SERVICE_PAGE}?code=${encodeURIComponent(code)}`;

      // pokaż przycisk awaryjny + automatyczny redirect
      box.style.display = "block";
      error.style.display = "none";
      bike.innerText = "Tryb serwisanta";
      status.innerText = "Zalogowano ✅";
      status.className = "status gotowe";
      message.innerText = "Przekierowuję do widoku serwisanta…";
      hint.innerText = "Jeśli przekierowanie nie zadziała, kliknij przycisk poniżej.";
      openServiceBtn.style.display = "inline-flex";
      openServiceBtn.href = target;

      // krótka zwłoka żeby UI zdążył się wyrenderować
      setTimeout(()=>{ location.replace(target); }, 300);
      return;
    }

    // 2) w przeciwnym razie → klient
    hint.innerText = "";
    await loadClientView();
  }

  main();
</script>

</body>
</html>
