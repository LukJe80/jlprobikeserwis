<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Zako≈Ñczone zlecenia</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#070b1a;
  color:#e6ecff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
.wrapper{
  max-width:1200px;
  margin:30px auto;
  padding:20px;
}
h1{
  margin-bottom:6px;
}
.sub{
  opacity:.7;
  font-size:14px;
}
.table-wrap{
  margin-top:20px;
  overflow-x:auto;
  border-radius:14px;
  background:#0d1226;
  box-shadow:0 0 0 1px rgba(255,255,255,.04);
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:900px;
}
th,td{
  padding:14px;
  text-align:left;
  border-bottom:1px solid rgba(255,255,255,.05);
}
th{
  color:#8fb3ff;
  font-size:13px;
  font-weight:600;
}
tr:hover td{
  background:rgba(255,255,255,.03);
}
.actions{
  display:flex;
  gap:8px;
}
.btn{
  width:38px;
  height:38px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:18px;
  border:1px solid rgba(255,255,255,.15);
  background:#0b1024;
}
.btn.info{color:#ff5252;}
.btn.restore{color:#fff;}
.bell{
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}
.bell.green{background:#113d2b;color:#33ff99;}
.bell.yellow{background:#3d3411;color:#ffd84d;}
.bell.red{background:#3d1111;color:#ff5c5c;}
.empty{
  opacity:.5;
}
</style>
</head>

<body>
<div class="wrapper">
  <h1>Zako≈Ñczone zlecenia</h1>
  <div class="sub">‚Ñπ szczeg√≥≈Çy ‚Ä¢ ‚Ü© wznowienie ‚Ä¢ üîî przypomnienie</div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>KLIENT</th>
          <th>TELEFON</th>
          <th>ROWER</th>
          <th>OPIS</th>
          <th>AKCJE</th>
          <th>üîî</th>
          <th>ZAKO≈ÉCZONE</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="7" class="empty">≈Åadowanie‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://mzgxv11t1crvzmtswzql.supabase.co",
  "PUBLIC_ANON_KEY_TU_NIC_NIE_TRZEBA"
);

// helper odporny na r√≥≈ºne nazwy kolumn
function pick(o, keys){
  for(const k of keys){
    const v = o?.[k];
    if(v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}
function esc(s){
  return String(s||"").replace(/[&<>"']/g,m=>(
    {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]
  ));
}

// kolor dzwonka
function reminderBell(o){
  if(!o.reminder_months || !o.archived_at){
    return `<div class="bell green">üîî</div>`;
  }
  const archived = new Date(o.archived_at);
  const now = new Date();
  const total = o.reminder_months * 30;
  const passed = (now - archived) / (1000*60*60*24);
  const pct = passed / total;

  if(pct >= 0.9) return `<div class="bell red">üîî</div>`;
  if(pct >= 0.7) return `<div class="bell yellow">üîî</div>`;
  return `<div class="bell green">üîî</div>`;
}

async function load(){
  const {data,error} = await supabase
    .from("orders")
    .select("*")
    .not("archived_at","is",null)
    .order("archived_at",{ascending:false});

  const tbody = document.getElementById("rows");
  if(error){
    tbody.innerHTML = `<tr><td colspan="7">B≈ÇƒÖd</td></tr>`;
    return;
  }
  if(!data.length){
    tbody.innerHTML = `<tr><td colspan="7" class="empty">Brak archiwalnych zlece≈Ñ</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(o=>`
    <tr>
      <td>${esc(pick(o,["customer","client","client_name","customer_name"]))}</td>
      <td>${esc(pick(o,["phone","tel","telephone"]))}</td>
      <td>${esc(pick(o,["bike","bike_name","bike_model","bike_type"]))}</td>
      <td>${esc(pick(o,["note","issue_description","description","work_done"]))}</td>
      <td class="actions">
        <div class="btn info" title="Szczeg√≥≈Çy" onclick="info('${o.id}')">‚Ñπ</div>
        <div class="btn restore" title="Wzn√≥w" onclick="restore('${o.id}')">‚Ü©</div>
      </td>
      <td>${reminderBell(o)}</td>
      <td>${new Date(o.archived_at).toLocaleString()}</td>
    </tr>
  `).join("");
}

function info(id){
  location.href = `/panel/order-history.html?id=${id}`;
}

async function restore(id){
  if(!confirm("Wznowiƒá zlecenie?")) return;

  const {error} = await supabase
    .from("orders")
    .update({
      archived_at: null,
      status: "nowe",
      reminder_months: null,
      reminder_note: null,
      public_code: crypto.randomUUID()
    })
    .eq("id",id);

  if(error){
    alert("B≈ÇƒÖd wznowienia");
    return;
  }
  load();
}

load();
</script>
</body>
</html>
