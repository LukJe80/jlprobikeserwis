<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Historia zleceÅ„ â€“ JL Pro Bike Serwis</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabaseClient.js"></script>

<style>
:root{
  --accent:#2563eb;
  --bg:#020617;
  --text:#e5e7eb;
  --panel:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.1);

  --ok:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ===== HEADER ===== */
header{
  position:fixed;
  top:0;
  width:100%;
  z-index:10;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 24px;
  background:rgba(2,6,23,.8);
  backdrop-filter:blur(6px);
  border-bottom:1px solid var(--border);
}

header h1{
  margin:0;
  font-size:18px;
  color:var(--accent);
  display:flex;
  gap:8px;
}

.toplink{
  color:#fff;
  text-decoration:none;
  font-weight:700;
}
.toplink:hover{color:var(--accent)}

/* ===== MAIN ===== */
main{
  max-width:1100px;
  margin:auto;
  padding:120px 24px 80px;
}

.box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:22px;
}

.page-title{
  font-size:28px;
  font-weight:900;
}

.hint{
  font-size:13px;
  opacity:.7;
  margin-bottom:14px;
}

/* ===== TABLE ===== */
.table-wrap{
  overflow-x:auto;
  border-radius:14px;
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:900px;
}

th,td{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.08);
  font-size:14px;
}

th{
  font-size:12px;
  color:#93c5fd;
  text-transform:uppercase;
}

tr:hover{background:rgba(255,255,255,.04)}

.actions{
  display:flex;
  gap:10px;
}

/* ===== ACTION BUTTONS ===== */
.btnIcon{
  width:40px;
  height:40px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.05);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.btnIcon:hover{
  border-color:var(--accent);
  background:rgba(37,99,235,.15);
}

.btnInfo i{color:var(--danger)}
.btnResume i{color:#fff}

/* ===== REMINDER ===== */
.rem{
  width:40px;
  height:40px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  display:flex;
  align-items:center;
  justify-content:center;
}

.rem.ok{border-color:rgba(34,197,94,.4)}
.rem.ok i{color:var(--ok)}

.rem.warn{border-color:rgba(245,158,11,.4)}
.rem.warn i{color:var(--warn)}

.rem.danger{border-color:rgba(239,68,68,.4)}
.rem.danger i{color:var(--danger)}

.remDash{opacity:.6}

/* MOBILE */
@media(max-width:700px){
  main{padding:110px 14px}
}
</style>
</head>

<body>

<header>
  <h1><i class="fa-solid fa-box-archive"></i> Historia zleceÅ„</h1>
  <a class="toplink" href="orders.html"><i class="fa-solid fa-arrow-left"></i> PowrÃ³t</a>
</header>

<main>
  <div class="box">
    <div class="page-title">ZakoÅ„czone zlecenia</div>
    <div class="hint">
      â„¹ szczegÃ³Å‚y â€¢ â†© wznowienie â€¢ ðŸ”” przypomnienie
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Klient</th>
            <th>Telefon</th>
            <th>Rower</th>
            <th>Opis</th>
            <th>Akcje</th>
            <th>ðŸ””</th>
            <th>ZakoÅ„czone</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
function esc(t){
  return (t??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function formatDate(d){
  return d ? new Date(d).toLocaleString("pl-PL") : "";
}

/* ===== REMINDER LOGIC ===== */
function reminderCell(o){
  if(!o.reminder_months || !o.archived_at){
    return `<span class="remDash">â€”</span>`;
  }

  const start = new Date(o.archived_at);
  const due = new Date(start);
  due.setMonth(due.getMonth() + o.reminder_months);

  const total = due - start;
  const now = Date.now();
  const passed = now - start;

  if(passed <= 0) return `<div class="rem ok"><i class="fa-solid fa-bell"></i></div>`;

  const percent = passed / total;

  if(percent < .5) return `<div class="rem ok"><i class="fa-solid fa-bell"></i></div>`;
  if(percent < .9) return `<div class="rem warn"><i class="fa-solid fa-bell"></i></div>`;
  return `<div class="rem danger"><i class="fa-solid fa-bell"></i></div>`;
}

/* ===== LOAD ORDERS ===== */
async function load(){
  const { data, error } = await supabaseClient
    .from("orders")
    .select("*")
    .not("archived_at","is",null)
    .order("archived_at",{ascending:false});

  if(error){
    alert(error.message);
    return;
  }

  rows.innerHTML = data.map(o=>`
    <tr>
      <td>${esc(o.customer)}</td>
      <td>${esc(o.phone)}</td>
      <td>${esc(o.bike)}</td>
      <td>${esc(o.note)}</td>
      <td>
        <div class="actions">
          <a class="btnIcon btnInfo" href="order-history.html?id=${o.id}">
            <i class="fa-solid fa-circle-info"></i>
          </a>
          <div class="btnIcon btnResume" onclick="resume('${o.id}')">
            <i class="fa-solid fa-rotate-left"></i>
          </div>
        </div>
      </td>
      <td>${reminderCell(o)}</td>
      <td>${formatDate(o.archived_at)}</td>
    </tr>
  `).join("");
}

/* ===== RESUME (NO DUPLICATE) ===== */
async function resume(id){
  if(!confirm("WznowiÄ‡ to zlecenie?")) return;

  const { error } = await supabaseClient
    .from("orders")
    .update({
      archived_at: null,
      status: "w trakcie"
    })
    .eq("id", id);

  if(error){
    alert(error.message);
    return;
  }

  window.location.href = "edit-order.html?id=" + id;
}

load();
</script>

</body>
</html>
