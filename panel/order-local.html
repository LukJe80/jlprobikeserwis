<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notatnik serwisanta (lokalnie)</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>

  <!-- Fallback QR lib (ładuje się zawsze – prościej i pewniej) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --card:#0b1224;
      --card2:#0a1020;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1e293b;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --good:#22c55e;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.18), transparent 55%),
                  radial-gradient(900px 700px at 80% 20%, rgba(37,99,235,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:rgba(2,6,23,.7);
      border-bottom:1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(8px);
    }
    .brand{
      font-weight:800; letter-spacing:.2px;
      color: var(--accent);
    }
    .top-actions{
      display:flex; gap:10px; align-items:center;
    }
    .iconbtn{
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
      cursor:pointer;
    }
    .iconbtn:hover{border-color:rgba(37,99,235,.6)}
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:18px 14px 80px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .title{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    h1{margin:0; font-size:22px}
    .sub{margin:6px 0 0; color:var(--muted); line-height:1.35}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(min-width:880px){
      .grid{grid-template-columns: 1fr 1fr;}
    }
    .section{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
      border-radius:16px;
      padding:14px;
    }
    .section h2{
      margin:0 0 10px;
      font-size:16px;
      display:flex; align-items:center; gap:10px;
      color: #cbd5e1;
    }
    textarea, input[type="text"], input[type="number"]{
      width:100%;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:12px;
      outline:none;
    }
    textarea{min-height:140px; resize:vertical}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex; align-items:center; gap:10px;
      color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .btn:hover{border-color: rgba(37,99,235,.5)}
    .btn-main{
      background: var(--accent);
      border-color: rgba(37,99,235,.9);
    }
    .btn-main:hover{background: var(--accent2)}
    .btn-bad{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.45);
      color:#fecaca;
    }
    .btn-good{
      background: rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.45);
      color:#bbf7d0;
    }
    .msg{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .msg.good{border-color: rgba(34,197,94,.45); color:#bbf7d0}
    .msg.bad{border-color: rgba(239,68,68,.45); color:#fecaca}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:min(720px, 96vw);
      background: rgba(10,16,32,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0; font-size:16px}
    .qrBox{
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:#000;
    }
    #qr-reader{ width:100%; }
    .small{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">JL Pro Bike Serwis</div>
    <div class="top-actions">
      <a class="iconbtn" href="orders.html" title="Zlecenia">
        <i class="fa-solid fa-list"></i> Zlecenia
      </a>
      <button class="iconbtn" onclick="openScan()" title="Skanuj QR">
        <i class="fa-solid fa-qrcode"></i>
      </button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="title">
        <div>
          <h1>Notatnik serwisanta (lokalnie)</h1>
          <div class="sub">
            Pobiera zlecenie z panelu (po zalogowaniu), ale <b>wycena/notatki/zdjęcia zapisują się tylko w telefonie</b>.
          </div>
        </div>
        <div class="pill"><i class="fa-solid fa-shield-halved"></i> lokalne dane</div>
      </div>

      <div id="info" class="msg">Wczytywanie…</div>

      <div class="grid" id="mainUI" style="display:none;">
        <div class="section">
          <h2><i class="fa-solid fa-receipt"></i> Wycena (lista + suma)</h2>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn btn-main" onclick="saveLocal()">
              <i class="fa-solid fa-floppy-disk"></i> Zapisz lokalnie
            </button>
            <button class="btn" onclick="copySms()">
              <i class="fa-solid fa-comment-sms"></i> Kopiuj SMS (wycena)
            </button>
            <button class="btn btn-good" onclick="pushCostToPanel()">
              <i class="fa-solid fa-cloud-arrow-up"></i> Wyślij wycenę do panelu
            </button>
          </div>

          <textarea id="costText" placeholder="Np:
- Regulacja przerzutek 40 zł
- Dętka 25 zł
- Centrowanie koła 60 zł
..."></textarea>

          <div class="row" style="margin-top:10px;">
            <input id="sumInput" type="number" step="1" min="0" placeholder="Suma (zł) – wpisz ręcznie albo zostaw 0">
            <button class="btn" onclick="calcSum()"><i class="fa-solid fa-calculator"></i> Przelicz sumę</button>
          </div>

          <div class="small">
            Tip: w tej wersji suma liczy się prosto z końcówek “XX zł” w tekście albo możesz wpisać ręcznie.
          </div>
        </div>

        <div class="section">
          <h2><i class="fa-solid fa-note-sticky"></i> Notatki lokalne</h2>
          <textarea id="notes" placeholder="Notatki (lokalnie):
- trudny klient…
- uwagi do roweru…
- co zrobić przy odbiorze…"></textarea>

          <div class="row" style="margin-top:10px;">
            <button class="btn" onclick="exportBackup()"><i class="fa-solid fa-file-export"></i> Export backup</button>
            <button class="btn" onclick="importBackup()"><i class="fa-solid fa-file-import"></i> Import backup</button>
            <button class="btn btn-bad" onclick="clearLocal()"><i class="fa-solid fa-trash"></i> Wyczyść lokalne dane</button>
          </div>

          <div class="small" style="margin-top:10px;">
            Auto-backup zapisuje się w telefonie przy wyjściu z ekranu. Backup eksportuje plik .json.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL QR -->
  <div class="modalBack" id="qrModal">
    <div class="modal">
      <div class="modalHead">
        <h3><i class="fa-solid fa-qrcode"></i> Skanuj kod QR</h3>
        <button class="btn btn-bad" onclick="closeScan()"><i class="fa-solid fa-xmark"></i> Zamknij</button>
      </div>

      <div class="qrBox">
        <div id="qr-reader"></div>
      </div>

      <div class="small">
        Jeśli QR zawiera link do statusu (np. .../order-status.html?id=123), to zostanie automatycznie otwarty.
        <br>Uwaga: kamera działa tylko na HTTPS i po udzieleniu zgody w przeglądarce.
      </div>

      <div id="qrMsg" class="msg" style="margin-top:10px; display:none;"></div>
    </div>
  </div>

<script>
  const sb = window.supabaseClient;

  // ====== Helpers ======
  const qs = (k)=> new URLSearchParams(location.search).get(k);

  function showInfo(text, kind=""){
    const el = document.getElementById("info");
    el.className = "msg" + (kind ? " "+kind : "");
    el.textContent = text;
  }

  function toast(text, ok=true){
    const el = document.getElementById("qrMsg");
    el.style.display="block";
    el.className = "msg " + (ok ? "good":"bad");
    el.textContent = text;
  }

  // ====== Local keys ======
  const keyCostText = (id)=> `local_costText_${id}`;
  const keyCostTotal = (id)=> `local_costTotal_${id}`;
  const keyNotes = (id)=> `local_notes_${id}`;
  const keyBackup = ()=> `local_lastBackup`;

  function touchBackup(){
    try{
      const payload = {
        ts: Date.now(),
        url: location.href
      };
      localStorage.setItem(keyBackup(), JSON.stringify(payload));
    }catch(e){}
  }

  // ====== Load order from Supabase ======
  let orderCache = null;
  let currentTotal = 0;

  async function loadOrder(){
    const id = qs("id");
    if(!id){
      showInfo("Brak ID zlecenia w linku. Otwórz zlecenie z listy albo zeskanuj QR.", "bad");
      return;
    }

    showInfo("Wczytywanie zlecenia…");

    try{
      const { data:sessionWrap } = await sb.auth.getSession();
      if(!sessionWrap || !sessionWrap.session){
        showInfo("Brak zalogowania. Otwórz panel i zaloguj się, potem wróć do tego linku.", "bad");
        return;
      }

      const { data, error } = await sb
        .from("orders")
        .select("id, customer_name, phone, bike_type, status, created_at, description, problem_description, costs_text, total_cost, labor_cost")
        .eq("id", id)
        .single();

      if(error || !data){
        showInfo("Nie znaleziono zlecenia lub brak uprawnień.", "bad");
        return;
      }

      orderCache = data;

      // ✅ ONLINE -> LOKALNIE: jeśli lokalnie pusto, wczytaj kosztorys z panelu
      const localCost = (localStorage.getItem(keyCostText(id)) || "").trim();
      if(!localCost){
        const onlineCost = (data.costs_text || "").trim();
        if(onlineCost){
          localStorage.setItem(keyCostText(id), onlineCost);

          const onlineTotal = (data.total_cost ?? data.labor_cost ?? null);
          if(onlineTotal !== null && onlineTotal !== undefined){
            localStorage.setItem(keyCostTotal(id), String(onlineTotal));
          }
        }
      }

      // fill UI from local
      document.getElementById("costText").value = localStorage.getItem(keyCostText(id)) || "";
      document.getElementById("sumInput").value = localStorage.getItem(keyCostTotal(id)) || "0";
      document.getElementById("notes").value = localStorage.getItem(keyNotes(id)) || "";

      document.getElementById("mainUI").style.display = "grid";

      showInfo(`Zlecenie: ${data.customer_name || "(brak)"} • ${data.bike_type || ""}`, "good");
      touchBackup();

    }catch(e){
      showInfo("Błąd ładowania: " + (e?.message || e), "bad");
    }
  }

  // ====== Calc sum ======
  function calcSum(){
    const text = document.getElementById("costText").value || "";
    // proste zliczanie: szuka liczb przed "zł"
    const matches = [...text.matchAll(/(\d+)\s*zł/gi)].map(m=>parseInt(m[1],10)).filter(n=>!isNaN(n));
    const sum = matches.reduce((a,b)=>a+b,0);
    currentTotal = sum;

    // jeśli user ma ręcznie wpisaną sumę > 0, nie nadpisuj
    const manual = parseInt(document.getElementById("sumInput").value || "0", 10);
    if(!manual || manual === 0){
      document.getElementById("sumInput").value = String(sum);
    }
    return sum;
  }

  // ====== Save local ======
  function saveLocal(){
    const id = qs("id");
    if(!id) return;

    calcSum();
    localStorage.setItem(keyCostText(id), document.getElementById("costText").value || "");
    localStorage.setItem(keyCostTotal(id), document.getElementById("sumInput").value || "0");
    localStorage.setItem(keyNotes(id), document.getElementById("notes").value || "");
    touchBackup();
    showInfo("Zapisano lokalnie ✅", "good");
  }

  // ====== Copy SMS ======
  function copySms(){
    const id = qs("id");
    calcSum();
    const sum = document.getElementById("sumInput").value || "0";
    const txt = (document.getElementById("costText").value || "").trim();

    const who = orderCache?.customer_name ? `${orderCache.customer_name}` : "Klient";
    const bike = orderCache?.bike_type ? ` (${orderCache.bike_type})` : "";

    const msg =
`JL Pro Bike Serwis
${who}${bike}

Wycena: ${sum} zł

Pozycje:
${txt || "- (brak)"}`;

    navigator.clipboard.writeText(msg).then(()=>{
      showInfo("Skopiowano SMS do schowka ✅", "good");
    }).catch(()=>{
      showInfo("Nie udało się skopiować (brak uprawnień schowka).", "bad");
    });
  }

  // ====== Push cost to panel ======
  async function pushCostToPanel(){
    const orderId = qs("id");
    if(!orderId){
      showInfo("Brak ID zlecenia.", "bad");
      return;
    }

    calcSum();
    const text = (document.getElementById("costText").value || "").trim();
    const total = parseInt(document.getElementById("sumInput").value || "0",10) || 0;

    const payload = { costs_text: text, labor_cost: total, total_cost: total };

    const { error } = await sb.from("orders").update(payload).eq("id", orderId);
    if(error){
      showInfo("Błąd wysyłki do panelu: " + error.message, "bad");
      return;
    }

    showInfo("Wysłano wycenę do panelu ✅", "good");
  }
  window.pushCostToPanel = pushCostToPanel;

  // ====== Backup export/import ======
  function exportBackup(){
    const id = qs("id");
    if(!id) return;

    const payload = {
      version: 1,
      orderId: id,
      ts: Date.now(),
      costText: localStorage.getItem(keyCostText(id)) || "",
      costTotal: localStorage.getItem(keyCostTotal(id)) || "0",
      notes: localStorage.getItem(keyNotes(id)) || ""
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup-order-${id}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showInfo("Wyeksportowano backup ✅", "good");
  }

  function importBackup(){
    const id = qs("id");
    if(!id) return;

    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async ()=>{
      const f = inp.files?.[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const data = JSON.parse(txt);
        localStorage.setItem(keyCostText(id), data.costText || "");
        localStorage.setItem(keyCostTotal(id), data.costTotal || "0");
        localStorage.setItem(keyNotes(id), data.notes || "");
        document.getElementById("costText").value = data.costText || "";
        document.getElementById("sumInput").value = data.costTotal || "0";
        document.getElementById("notes").value = data.notes || "";
        showInfo("Zaimportowano backup ✅", "good");
      }catch(e){
        showInfo("Błąd importu backupu.", "bad");
      }
    };
    inp.click();
  }

  function clearLocal(){
    const id = qs("id");
    if(!id) return;
    if(!confirm("Usunąć lokalne dane dla tego zlecenia?")) return;
    localStorage.removeItem(keyCostText(id));
    localStorage.removeItem(keyCostTotal(id));
    localStorage.removeItem(keyNotes(id));
    document.getElementById("costText").value = "";
    document.getElementById("sumInput").value = "0";
    document.getElementById("notes").value = "";
    showInfo("Wyczyszczono lokalne dane ✅", "good");
  }

  // ====== QR scan (naprawione) ======
  let html5Qr = null;

  function openScan(){
    document.getElementById("qrModal").style.display="flex";
    toast("Proszę zaakceptować dostęp do aparatu, jeśli wyskoczy pytanie.", true);

    // Start dopiero po kliknięciu (user gesture) — to jest ważne.
    startQr();
  }

  async function closeScan(){
    document.getElementById("qrModal").style.display="none";
    await stopQr();
  }

  async function stopQr(){
    try{
      if(html5Qr){
        await html5Qr.stop();
        html5Qr.clear();
        html5Qr = null;
      }
    }catch(e){}
  }

  function extractIdFromQrText(text){
    try{
      // 1) jeśli to URL z parametrem id:
      if(text.includes("http")){
        const u = new URL(text);
        const id = u.searchParams.get("id");
        if(id) return id;
      }
    }catch(e){}

    // 2) jeśli QR ma tylko liczbę/ID:
    const raw = (text || "").trim();
    if(raw && raw.length <= 36) return raw; // supabase uuid też przejdzie
    return null;
  }

  async function startQr(){
    // Uwaga: jeśli ktoś otworzy w WebView (np. FB/Messenger) kamera bywa blokowana.
    // Najlepiej Chrome/Safari albo PWA.
    await stopQr();

    const elId = "qr-reader";

    try{
      html5Qr = new Html5Qrcode(elId);

      // prefer back camera
      const config = { fps: 10, qrbox: { width: 260, height: 260 } };

      await html5Qr.start(
        { facingMode: "environment" },
        config,
        (decodedText)=>{
          const id = extractIdFromQrText(decodedText);
          if(!id){
            toast("Zeskanowano, ale nie rozpoznano ID w QR.", false);
            return;
          }
          toast("OK ✅ Otwieram zlecenie: " + id, true);

          // jeśli QR jest linkiem do statusu – też zadziała, ale my bierzemy ID i otwieramy lokalny notatnik
          setTimeout(()=>{
            location.href = `order-local.html?id=${encodeURIComponent(id)}`;
          }, 300);
        },
        ()=>{
          // onScanFailure – ignorujemy
        }
      );

      toast("Kamera uruchomiona ✅ Skanuj kod…", true);

    }catch(e){
      // Najczęstsze: NotAllowedError / NotFoundError / NotReadableError
      const msg = e?.name ? `${e.name}: ${e.message || ""}` : (e?.message || String(e));
      toast("Nie udało się uruchomić kamery. " + msg, false);
      toast("Sprawdź: HTTPS, zgoda na kamerę, oraz czy nie otwierasz w przeglądarce Facebook/Messenger.", false);
    }
  }

  window.openScan = openScan;
  window.closeScan = closeScan;

  // Auto backup “cicho” przy zamknięciu/ukryciu
  window.addEventListener("beforeunload", ()=>{ try{ saveLocal(); }catch(e){} });
  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "hidden"){
      try{ saveLocal(); }catch(e){}
    }
  });

  // Start
  loadOrder();
</script>
</body>
</html>
