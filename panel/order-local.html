<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notatnik serwisanta (lokalnie) — JL Pro Bike Serwis</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ✅ kluczowe: absolutna ścieżka (działa z /panel/) -->
  <script src="/supabaseClient.js"></script>

  <style>
    :root{
      --accent:#2563eb;
      --accentHover:#1d4ed8;
      --bg:#020617;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --card:#0b1222;
      --border:rgba(255,255,255,0.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(37,99,235,.08), transparent 60%),
        var(--bg);
    }
    a{color:inherit;text-decoration:none}

    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:rgba(2,6,23,.72);
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .brand{
      font-weight:800;
      color:var(--accent);
      letter-spacing:.2px;
      font-size:18px;
    }
    .h-actions{
      display:flex; gap:10px; align-items:center;
    }
    .iconbtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-weight:700;
    }
    .iconbtn:hover{border-color: rgba(37,99,235,.55); color: var(--accent)}
    .icononly{
      width:44px; height:44px; justify-content:center; padding:0;
    }

    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 60px;}
    .card{
      background:rgba(11,18,34,.7);
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .card h1{
      margin:0 0 8px;
      font-size:28px;
      letter-spacing:.2px;
    }
    .sub{color:var(--muted); margin:0 0 14px; line-height:1.35}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .pill.ok{color:#bbf7d0;border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08)}
    .pill.warn{color:#fde68a;border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.08)}
    .pill.bad{color:#fecaca;border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:860px){ .grid{grid-template-columns:1fr} }

    .section-title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
      font-size:16px;
      font-weight:800;
      color:#cbd5e1;
    }
    .section-title i{color:var(--accent)}

    .box{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:rgba(255,255,255,.02);
    }

    input, textarea, select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(2,6,23,.35);
      color:var(--text);
      padding:12px;
      outline:none;
      font-size:15px;
    }
    textarea{min-height:110px; resize:vertical}
    input:focus, textarea:focus, select:focus{border-color: rgba(37,99,235,.6)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:800;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color: rgba(37,99,235,.55); color: var(--accent)}
    .btn-main{
      background:var(--accent);
      border-color:transparent;
      color:white;
    }
    .btn-main:hover{background:var(--accentHover); color:white}
    .btn-danger{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.35);
      color:#fecaca;
    }
    .btn-danger:hover{border-color:rgba(239,68,68,.55); color:white; background:rgba(239,68,68,.18)}
    .btn-ghost{
      background:transparent;
      border-color:rgba(255,255,255,0.08);
      color:#cbd5e1;
    }

    .list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
    }
    .item .left{display:flex; flex-direction:column; gap:2px}
    .item .name{font-weight:800}
    .item .meta{color:var(--muted); font-size:13px}
    .price{font-weight:900}

    .sum{
      margin-top:12px;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(37,99,235,.35);
      background:rgba(37,99,235,.08);
      font-weight:900;
    }

    .notice{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
      color:var(--muted);
      line-height:1.35;
      font-size:14px;
    }
    .notice.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08); color:#fecaca}
    .notice.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08); color:#bbf7d0}

    /* Modal QR */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:200;
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(680px, 100%);
      background:rgba(11,18,34,.9);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .modal-head h3{margin:0; font-size:16px}
    .modal-body{padding:14px}
    video{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:#000;
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">JL Pro Bike Serwis</div>
    <div class="h-actions">
      <a class="iconbtn" href="orders.html" title="Zlecenia">
        <i class="fa-solid fa-list"></i><span>Zlecenia</span>
      </a>
      <button class="iconbtn icononly" onclick="openQrModal()" title="Skanuj QR">
        <i class="fa-solid fa-qrcode"></i>
      </button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between; gap:10px;">
        <div>
          <h1><i class="fa-solid fa-calculator" style="color:var(--accent)"></i> Notatnik serwisanta (lokalnie)</h1>
          <p class="sub">
            Pobiera zlecenie z panelu (po zalogowaniu), ale <b>wycena/notatki</b> zapisują się w telefonie.
            <br/>Opcjonalnie możesz wysłać <b>kosztorys do panelu</b> (kolumna <code>costs_text</code>).
          </p>
        </div>
        <div class="row">
          <span id="localBadge" class="pill warn"><i class="fa-solid fa-shield-halved"></i> lokalne dane</span>
        </div>
      </div>

      <div id="topNotice" class="notice bad" style="display:none"></div>

      <div class="grid">
        <!-- LEWA: dane zlecenia -->
        <div class="box">
          <div class="section-title">
            <span><i class="fa-solid fa-receipt"></i> Zlecenie</span>
          </div>

          <div class="row">
            <div style="flex:1">
              <label class="sub" style="display:block;margin:0 0 6px;">Klient</label>
              <input id="clientName" readonly />
            </div>
            <div style="flex:1">
              <label class="sub" style="display:block;margin:0 0 6px;">Telefon</label>
              <input id="clientPhone" readonly />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div style="flex:1">
              <label class="sub" style="display:block;margin:0 0 6px;">Rower</label>
              <input id="bikeName" readonly />
            </div>
            <div style="flex:1">
              <label class="sub" style="display:block;margin:0 0 6px;">Status</label>
              <input id="statusText" readonly />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label class="sub" style="display:block;margin:0 0 6px;">Opis zlecenia (z panelu)</label>
            <textarea id="problemDesc" readonly></textarea>
          </div>

          <div style="margin-top:12px;" class="notice">
            <b>QR:</b> możesz wkleić link/tekst QR w pole niżej i kliknąć „Otwórz”.
            <div class="row" style="margin-top:10px;">
              <input id="qrTextManual" placeholder="Wklej tu link z QR (np. .../order-status.html?code=...)" />
              <button class="btn" onclick="openFromQrText()"><i class="fa-solid fa-arrow-right"></i> Otwórz</button>
            </div>
          </div>
        </div>

        <!-- PRAWA: lokalne notatki + kosztorys -->
        <div class="box">
          <div class="section-title">
            <span><i class="fa-solid fa-pen-to-square"></i> Notatki i kosztorys</span>
          </div>

          <label class="sub" style="display:block;margin:0 0 6px;">Notatki (tylko telefon)</label>
          <textarea id="localNotes" placeholder="np. trudny klient, uwagi, co było zużyte..."></textarea>

          <div style="margin-top:12px;">
            <div class="section-title" style="margin:0 0 8px;">
              <span><i class="fa-solid fa-list-check"></i> Pozycje (lokalnie)</span>
            </div>

            <div class="row">
              <input id="itemName" placeholder="np. linka przerzutki" />
              <input id="itemPrice" type="number" inputmode="decimal" placeholder="cena (zł)" style="max-width:160px"/>
              <select id="itemType" style="max-width:190px">
                <option value="czynność">czynność</option>
                <option value="część">część</option>
              </select>
              <button class="btn btn-main" onclick="addItem()"><i class="fa-solid fa-plus"></i> Dodaj</button>
            </div>

            <ul id="itemsList" class="list"></ul>
            <div class="sum">
              <span>Suma</span>
              <span id="sumValue">0 zł</span>
            </div>

            <div class="row" style="margin-top:12px; justify-content:space-between;">
              <button class="btn" onclick="saveLocal()"><i class="fa-solid fa-floppy-disk"></i> Zapisz lokalnie</button>
              <button class="btn" onclick="copySms()"><i class="fa-solid fa-comment-sms"></i> Kopiuj SMS (wycena)</button>
            </div>

            <div class="notice" style="margin-top:12px;">
              <div class="section-title" style="margin:0 0 8px;">
                <span><i class="fa-solid fa-cloud-arrow-down"></i> Kosztorys z panelu (Supabase)</span>
              </div>
              <textarea id="panelCosts" readonly placeholder="Tu pojawi się costs_text z panelu (jeśli istnieje)"></textarea>

              <div class="row" style="margin-top:10px;">
                <button class="btn" onclick="pullCostsFromPanel()">
                  <i class="fa-solid fa-rotate"></i> Pobierz z panelu
                </button>
                <button class="btn btn-main" onclick="pushCostsToPanel()">
                  <i class="fa-solid fa-cloud-arrow-up"></i> Zapisz do panelu (kosztorys)
                </button>
              </div>

              <div id="syncNotice" class="notice" style="display:none; margin-top:10px;"></div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn btn-danger" onclick="clearLocal()"><i class="fa-solid fa-trash"></i> Wyczyść lokalne dane</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAL QR -->
  <div id="qrModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3><i class="fa-solid fa-qrcode" style="color:var(--accent)"></i> Skanuj kod QR</h3>
        <button class="btn btn-danger" onclick="closeQrModal()"><i class="fa-solid fa-xmark"></i> Zamknij</button>
      </div>
      <div class="modal-body">
        <p class="sub" style="margin-top:0">
          Kamera działa tylko na <b>HTTPS</b> i po udzieleniu zgody w przeglądarce.
          Nie otwieraj w przeglądarce Facebook/Messenger.
        </p>

        <div id="qrErr" class="notice bad" style="display:none"></div>

        <video id="qrVideo" playsinline></video>

        <div class="row" style="margin-top:12px;">
          <button class="btn btn-main" onclick="startQrScan()"><i class="fa-solid fa-camera"></i> Uruchom kamerę</button>
          <button class="btn" onclick="stopQrScan()"><i class="fa-solid fa-stop"></i> Zatrzymaj</button>
        </div>

        <div class="notice" style="margin-top:12px;">
          Jeśli kamera nie rusza: wejdź w ustawienia telefonu → uprawnienia → przeglądarka → <b>Kamera: Zezwól</b>.
        </div>
      </div>
    </div>
  </div>

<script>
  // ==============================
  // Helpers / state
  // ==============================
  const ORDER_TABLE = "orders";

  let order = null;
  let orderKey = null; // klucz lokalny (code/id)
  let orderMatch = null; // { field: 'public_code'|'id', value: '...' }

  let qrStream = null;
  let qrLoopTimer = null;

  function $(id){ return document.getElementById(id); }

  function showTop(msg, type="bad"){
    const el = $("topNotice");
    el.className = "notice " + (type==="ok" ? "ok" : "bad");
    el.style.display = "block";
    el.textContent = msg;
  }
  function hideTop(){
    $("topNotice").style.display="none";
  }
  function showSync(msg, type="ok"){
    const el = $("syncNotice");
    el.className = "notice " + (type==="ok" ? "ok" : "bad");
    el.style.display = "block";
    el.textContent = msg;
  }

  function parseQuery(){
    const p = new URLSearchParams(location.search);

    // ✅ wspieramy: ?code=  OR ?id=
    const code = (p.get("code") || "").trim();
    const id = (p.get("id") || "").trim();

    // Jeśli masz code -> zawsze public_code
    if(code){
      return { field:"public_code", value: code, key: "code:"+code };
    }

    // jeśli id wygląda jak UUID -> potraktuj jak public_code (bo QR/kliencki kod)
    if(id){
      const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);
      if(isUuid){
        return { field:"public_code", value:id, key:"code:"+id };
      }
      // w innym wypadku traktuj jako id (liczba / string)
      return { field:"id", value: isNaN(Number(id)) ? id : Number(id), key:"id:"+id };
    }

    return null;
  }

  // ==============================
  // Auth / load order
  // ==============================
  async function ensureLoggedIn(){
    try{
      const { data } = await supabaseClient.auth.getSession();
      return !!(data && data.session);
    }catch(e){
      return false;
    }
  }

  async function loadOrder(){
    hideTop();

    orderMatch = parseQuery();
    if(!orderMatch){
      showTop("Brak parametru w linku. Dodaj ?code=... (zalecane) albo ?id=...", "bad");
      return;
    }
    orderKey = orderMatch.key;

    const ok = await ensureLoggedIn();
    if(!ok){
      showTop("Nie jesteś zalogowany w panelu. Otwórz najpierw login/panel i zaloguj się, potem wróć tutaj.", "bad");
      return;
    }

    try{
      const q = supabaseClient
        .from(ORDER_TABLE)
        .select("id, public_code, customer_name, phone, bike_type, bike_brand, description, status, costs_text")
        .eq(orderMatch.field, orderMatch.value)
        .limit(1);

      const { data, error } = await q;
      if(error) throw error;

      if(!data || !data.length){
        showTop("Nie znaleziono zlecenia lub brak uprawnień.", "bad");
        return;
      }

      order = data[0];
      fillOrder(order);

      // pobierz lokalne dane (jeśli są)
      loadLocal();

      // pokaż costs_text z panelu
      $("panelCosts").value = (order.costs_text || "").trim();

      // jeśli panel ma kosztorys -> spróbuj wypełnić listę (soft)
      if(order.costs_text && !getLocal().items?.length){
        tryAutofillItemsFromCostsText(order.costs_text);
      }

      $("localBadge").className = "pill ok";
      $("localBadge").innerHTML = '<i class="fa-solid fa-shield-halved"></i> gotowe';

    }catch(e){
      console.error(e);
      showTop("Błąd ładowania zlecenia. Sprawdź konsolę.", "bad");
    }
  }

  function fillOrder(o){
    const bike = [o.bike_type, o.bike_brand].filter(Boolean).join(" ");
    $("clientName").value = o.customer_name || "";
    $("clientPhone").value = o.phone || "";
    $("bikeName").value = bike || "";
    $("statusText").value = o.status || "";
    $("problemDesc").value = o.description || "";
  }

  // ==============================
  // Local storage (notes + items)
  // ==============================
  function localKey(){
    return "jl_local_" + (orderKey || "unknown");
  }
  function getLocal(){
    try{
      const raw = localStorage.getItem(localKey());
      return raw ? JSON.parse(raw) : { notes:"", items:[] };
    }catch{
      return { notes:"", items:[] };
    }
  }
  function setLocal(data){
    localStorage.setItem(localKey(), JSON.stringify(data));
  }

  function saveLocal(){
    if(!orderKey){
      showSync("Brak klucza zlecenia w URL.", "bad");
      return;
    }
    const data = getLocal();
    data.notes = $("localNotes").value || "";
    data.items = items.slice();
    data.updated_at = new Date().toISOString();
    setLocal(data);
    showSync("Zapisano lokalnie w telefonie.", "ok");
  }

  function loadLocal(){
    if(!orderKey) return;
    const data = getLocal();
    $("localNotes").value = data.notes || "";
    items = Array.isArray(data.items) ? data.items : [];
    renderItems();
  }

  function clearLocal(){
    if(!orderKey) return;
    localStorage.removeItem(localKey());
    $("localNotes").value = "";
    items = [];
    renderItems();
    showSync("Wyczyszczono lokalne dane.", "ok");
  }

  // ==============================
  // Items calculator (like edit-order: list + sum)
  // ==============================
  let items = [];

  function addItem(){
    const name = ($("itemName").value || "").trim();
    const price = Number(($("itemPrice").value || "").trim());
    const type = $("itemType").value;

    if(!name){
      showSync("Podaj nazwę pozycji.", "bad");
      return;
    }
    if(!isFinite(price) || price < 0){
      showSync("Podaj poprawną cenę.", "bad");
      return;
    }

    items.push({ name, price, type });
    $("itemName").value = "";
    $("itemPrice").value = "";
    renderItems();
  }

  function removeItem(idx){
    items.splice(idx, 1);
    renderItems();
  }

  function sum(){
    return items.reduce((a,it)=>a + (Number(it.price)||0), 0);
  }

  function renderItems(){
    const ul = $("itemsList");
    ul.innerHTML = "";
    items.forEach((it, idx)=>{
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div class="left">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="meta">${escapeHtml(it.type || "")}</div>
        </div>
        <div class="row" style="gap:10px;">
          <div class="price">${formatPLN(it.price)}</div>
          <button class="btn btn-ghost" onclick="removeItem(${idx})" title="Usuń">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      `;
      ul.appendChild(li);
    });
    $("sumValue").textContent = formatPLN(sum());
  }

  function formatPLN(v){
    const n = Number(v)||0;
    return n.toLocaleString("pl-PL") + " zł";
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ==============================
  // Sync with panel: costs_text
  // ==============================
  function formatCostsTextFromItems(){
    if(!items.length) return "";
    const lines = items.map(it=>{
      const price = Number(it.price)||0;
      return `${it.type}: ${it.name} — ${price} zł`;
    });
    lines.push(`Suma: ${sum()} zł`);
    return lines.join("\n");
  }

  function tryAutofillItemsFromCostsText(text){
    // próba "best effort": wyciąga liczby z końca linii
    const lines = String(text||"").split("\n").map(l=>l.trim()).filter(Boolean);
    const parsed = [];
    for(const line of lines){
      if(/^suma\s*:/i.test(line)) continue;
      // przykłady:
      // "część: linka — 25 zł"
      // "regulacja przerzutki 40"
      const m = line.match(/(.+?)(?:—|:)?\s*([0-9]+(?:[.,][0-9]+)?)\s*zł?$/i);
      if(m){
        const namePart = m[1].replace(/^(czynność|część)\s*:\s*/i,"").trim();
        const price = Number(m[2].replace(",","."));
        const typeMatch = line.match(/^(czynność|część)\s*:/i);
        parsed.push({ name: namePart, price: isFinite(price)?price:0, type: typeMatch ? typeMatch[1].toLowerCase() : "czynność" });
      }
    }
    if(parsed.length){
      items = parsed;
      renderItems();
      showSync("Wczytałem pozycje z kosztorysu z panelu (automatycznie). Sprawdź poprawność.", "ok");
    }
  }

  async function pullCostsFromPanel(){
    if(!orderMatch){
      showSync("Brak parametru ?code/?id.", "bad");
      return;
    }
    try{
      const { data, error } = await supabaseClient
        .from(ORDER_TABLE)
        .select("costs_text")
        .eq(orderMatch.field, orderMatch.value)
        .limit(1);

      if(error) throw error;
      const costs = (data && data[0] && data[0].costs_text) ? data[0].costs_text : "";
      $("panelCosts").value = (costs || "").trim();
      showSync("Pobrano kosztorys z panelu.", "ok");
    }catch(e){
      console.error(e);
      showSync("Nie udało się pobrać z panelu. Sprawdź uprawnienia/RLS.", "bad");
    }
  }

  async function pushCostsToPanel(){
    if(!orderMatch){
      showSync("Brak parametru ?code/?id.", "bad");
      return;
    }
    if(!items.length){
      showSync("Brak pozycji — dodaj coś do listy, żeby wysłać kosztorys.", "bad");
      return;
    }

    const payload = { costs_text: formatCostsTextFromItems() };

    try{
      const { error } = await supabaseClient
        .from(ORDER_TABLE)
        .update(payload)
        .eq(orderMatch.field, orderMatch.value);

      if(error) throw error;

      $("panelCosts").value = payload.costs_text;
      showSync("Zapisano kosztorys do panelu (costs_text).", "ok");
    }catch(e){
      console.error(e);
      showSync("Nie udało się zapisać do panelu. Możliwe RLS/brak uprawnień.", "bad");
    }
  }

  // ==============================
  // SMS (copy)
  // ==============================
  async function copySms(){
    if(!order){
      showSync("Najpierw wczytaj zlecenie.", "bad");
      return;
    }
    const bike = $("bikeName").value || "rower";
    const s = sum();
    const lines = items.map(it => `- ${it.name} (${it.type}): ${it.price} zł`);
    const msg =
`JL Pro Bike Serwis
${bike}

Kosztorys:
${lines.join("\n")}

Suma: ${s} zł`;

    try{
      await navigator.clipboard.writeText(msg);
      showSync("Skopiowano treść SMS do schowka.", "ok");
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = msg;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showSync("Skopiowano (tryb zgodności).", "ok");
    }
  }

  // ==============================
  // QR scanning
  // ==============================
  function openQrModal(){
    $("qrModal").classList.add("open");
    $("qrErr").style.display = "none";
  }
  function closeQrModal(){
    stopQrScan();
    $("qrModal").classList.remove("open");
  }

  function extractCodeOrIdFromText(text){
    const t = String(text||"").trim();
    if(!t) return null;

    // jeśli to URL - wyciągnij parametry
    try{
      const url = new URL(t);
      const sp = url.searchParams;
      const code = (sp.get("code") || "").trim();
      const id = (sp.get("id") || "").trim();
      if(code) return { field:"public_code", value: code, key:"code:"+code };
      if(id){
        const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);
        if(isUuid) return { field:"public_code", value:id, key:"code:"+id };
        return { field:"id", value: isNaN(Number(id)) ? id : Number(id), key:"id:"+id };
      }
    }catch(e){
      // nie URL — lecimy dalej
    }

    // jeśli wygląda jak UUID -> traktuj jako public_code
    if(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)){
      return { field:"public_code", value:t, key:"code:"+t };
    }

    // jeśli liczba -> id
    if(/^\d+$/.test(t)){
      return { field:"id", value:Number(t), key:"id:"+t };
    }

    return null;
  }

  function openFromQrText(){
    const t = $("qrTextManual").value;
    const m = extractCodeOrIdFromText(t);
    if(!m){
      showSync("Nie rozpoznałem kodu/linku. Wklej URL z ?code=... albo sam kod.", "bad");
      return;
    }
    const param = (m.field==="public_code") ? "code" : "id";
    location.href = `order-local.html?${param}=${encodeURIComponent(m.value)}`;
  }

  async function startQrScan(){
    $("qrErr").style.display = "none";

    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      $("qrErr").style.display = "block";
      $("qrErr").textContent = "Ta przeglądarka nie wspiera kamery (getUserMedia). Otwórz w Chrome/Samsung Internet.";
      return;
    }

    try{
      // ✅ ważne: wywołane po kliknięciu, inaczej przeglądarka blokuje
      qrStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });

      const video = $("qrVideo");
      video.srcObject = qrStream;
      await video.play();

      // BarcodeDetector (Chrome/Android) — najlepsze
      if("BarcodeDetector" in window){
        const detector = new BarcodeDetector({ formats: ["qr_code"] });
        qrLoopTimer = setInterval(async ()=>{
          try{
            const codes = await detector.detect(video);
            if(codes && codes.length){
              const raw = codes[0].rawValue;
              const m = extractCodeOrIdFromText(raw);
              if(m){
                stopQrScan();
                closeQrModal();
                const param = (m.field==="public_code") ? "code" : "id";
                location.href = `order-local.html?${param}=${encodeURIComponent(m.value)}`;
              }
            }
          }catch{}
        }, 350);
      }else{
        // Fallback: bez BarcodeDetector
        $("qrErr").style.display = "block";
        $("qrErr").textContent = "Brak wsparcia BarcodeDetector. Użyj wbudowanego skanera aparatu / Google Lens i wklej link w pole ręczne.";
      }

    }catch(e){
      console.error(e);
      $("qrErr").style.display = "block";
      $("qrErr").textContent = "Nie udało się uruchomić kamery. Sprawdź: HTTPS, zgoda na kamerę, oraz czy nie otwierasz w Facebook/Messenger.";
    }
  }

  function stopQrScan(){
    if(qrLoopTimer){
      clearInterval(qrLoopTimer);
      qrLoopTimer = null;
    }
    if(qrStream){
      qrStream.getTracks().forEach(t=>t.stop());
      qrStream = null;
    }
    const video = $("qrVideo");
    if(video){
      video.pause();
      video.srcObject = null;
    }
  }

  // ==============================
  // Init
  // ==============================
  window.addEventListener("beforeunload", ()=>{
    // cichy autosave lokalny
    try{ saveLocal(); }catch{}
  });

  loadOrder();
</script>
</body>
</html>
