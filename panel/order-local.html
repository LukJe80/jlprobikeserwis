<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notatnik serwisanta (lokalnie) — JL Pro Bike Serwis</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- WAŻNE: absolutna ścieżka, działa z /panel/ -->
  <script src="/supabaseClient.js"></script>

  <style>
    :root{
      --accent:#2563eb;
      --accentHover:#1d4ed8;
      --bg:#020617;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --card:#0b1222;
      --border:rgba(255,255,255,0.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(900px 600px at 15% -10%, rgba(37,99,235,.22), transparent 60%),
                  radial-gradient(900px 600px at 85% 0%, rgba(14,165,233,.14), transparent 65%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    header{
      position:fixed; left:0; right:0; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(2,6,23,.65);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .hwrap{
      max-width:1100px;
      margin:auto;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
      color:#60a5fa;
      text-decoration:none;
      font-size:18px;
    }
    .top-actions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      text-decoration:none;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(37,99,235,.55);
    }
    .btn-main{
      background: var(--accent);
      border-color: rgba(37,99,235,.75);
    }
    .btn-main:hover{ background: var(--accentHover); }
    .btn-danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
    }
    .btn-danger:hover{
      border-color: rgba(239,68,68,.65);
    }

    main{
      max-width:1100px;
      margin:auto;
      padding:96px 18px 60px;
    }

    .hero{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      padding:18px 18px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .hero h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
    }
    .hero p{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.55;
      max-width:820px;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .pill.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:16px;
    }
    @media(max-width:980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius:18px;
      padding:16px;
      box-shadow: var(--shadow);
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .section-title h2{
      margin:0;
      font-size:18px;
      color:#bfdbfe;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.2px;
      display:block;
      margin:10px 0 6px;
    }
    input, textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    textarea{
      min-height:96px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      line-height:1.5;
    }
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(max-width:640px){
      .two{ grid-template-columns:1fr; }
    }

    .notice{
      margin-top:12px;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color:var(--muted);
      line-height:1.5;
      font-size:13px;
    }
    .notice.bad{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color:#fecaca;
    }
    .notice.ok{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.08);
      color:#bbf7d0;
    }

    .sumBox{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      font-weight:1000;
      letter-spacing:.3px;
      font-size:34px;
      opacity:.95;
    }
    .sumBox span{
      display:inline-flex;
      align-items:baseline;
      gap:10px;
    }
    .sumBox b{
      font-size:14px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.6px;
    }

    .qrHint{
      margin-top:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.28);
      background: rgba(245,158,11,.08);
      color:#fde68a;
      font-weight:900;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.55);
      z-index:999;
    }
    .modal.open{ display:flex; }
    .modal-card{
      width:min(820px, 100%);
      border-radius:18px;
      background: rgba(2,6,23,.92);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modal-head h3{ margin:0; font-size:16px; display:flex; align-items:center; gap:10px; }
    .modal-body{ padding:14px 14px; }
    video{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:#000;
      max-height:52vh;
      object-fit:cover;
    }
  </style>
</head>

<body>
<header>
  <div class="hwrap">
    <a class="brand" href="/panel/index.html">
      JL Pro Bike Serwis
    </a>

    <div class="top-actions">
      <a class="btn" href="/panel/orders.html"><i class="fa-solid fa-list"></i> Zlecenia</a>
      <a class="btn" href="/"><i class="fa-solid fa-house"></i></a>
    </div>
  </div>
</header>

<main>
  <div class="hero">
    <div>
      <h1><i class="fa-solid fa-calculator" style="color:#60a5fa"></i> Notatnik serwisanta (lokalnie)</h1>
      <p>
        Pobiera zlecenie z panelu (po zalogowaniu), ale <b>wycena/notatki</b> zapisują się tylko w telefonie.
        Opcjonalnie możesz wysłać kosztorys do panelu (kolumna <code>costs_text</code>).
      </p>
    </div>
    <div class="row">
      <span id="localBadge" class="pill"><i class="fa-solid fa-shield-halved"></i> lokalne dane</span>
      <span id="panelBadge" class="pill"><i class="fa-solid fa-cloud"></i> panel</span>
    </div>
  </div>

  <div id="topNotice" class="notice bad" style="display:none; margin-top:12px;"></div>

  <div class="grid">
    <!-- LEWA -->
    <div class="card">
      <div class="section-title">
        <h2><i class="fa-solid fa-clipboard-list"></i> Zlecenie</h2>
      </div>

      <div class="two">
        <div>
          <label>Klient</label>
          <input id="clientName" readonly />
        </div>
        <div>
          <label>Telefon</label>
          <input id="clientPhone" readonly />
        </div>
      </div>

      <div class="two">
        <div>
          <label>Rower</label>
          <input id="bikeName" readonly />
        </div>
        <div>
          <label>Status</label>
          <input id="statusText" readonly />
        </div>
      </div>

      <label>Opis zgłoszenia klienta</label>
      <textarea id="problemDesc" readonly placeholder="Opis z panelu..."></textarea>

      <div class="qrHint">
        <i class="fa-solid fa-qrcode" style="margin-top:2px"></i>
        <div>
          QR: możesz wkleić link/tekst QR w pole w oknie skanera i kliknąć „Otwórz”.
          <div style="font-weight:700; color:var(--muted); margin-top:4px">
            Tip: skanuj zawieszkę z linkiem np. <code>.../panel/order-local.html?code=XXXX</code>
          </div>
        </div>
      </div>
    </div>

    <!-- PRAWA -->
    <div class="card">
      <div class="section-title">
        <h2><i class="fa-solid fa-pen-to-square"></i> Kalkulator (lokalnie) — notatki + koszt</h2>
      </div>

      <label>Notatki (tylko telefon)</label>
      <textarea id="localNotes" placeholder="np. trudny klient, uwagi, co było zużyte..."></textarea>

      <div class="row" style="margin-top:10px">
        <div style="flex:1; min-width:220px">
          <label style="margin-top:0">Dodaj pozycję</label>
          <input id="itemName" placeholder="np. serwis kompletny" />
        </div>
        <div style="width:160px; min-width:140px">
          <label style="margin-top:0">Cena (zł)</label>
          <input id="itemPrice" type="number" inputmode="decimal" placeholder="np. 350" />
        </div>
        <div style="width:190px; min-width:160px">
          <label style="margin-top:0">Typ</label>
          <select id="itemType">
            <option value="czynność">czynność</option>
            <option value="część">część</option>
          </select>
        </div>
        <div style="margin-top:22px">
          <button class="btn btn-main" onclick="addLineToCosts()"><i class="fa-solid fa-plus"></i> Dodaj</button>
        </div>
      </div>

      <label>Koszt (roboczy – do wydania roweru)</label>
      <textarea id="localCosts" placeholder="Każda linia może mieć kwotę, np.:
serwis kompletny 350 zł
serwis koła 100"></textarea>

      <div class="sumBox">
        <span><b>SUMA:</b> <span id="sumValue">0.00 zł</span></span>
      </div>

      <div class="row" style="margin-top:12px; justify-content:space-between;">
        <button class="btn" onclick="saveLocal()"><i class="fa-solid fa-floppy-disk"></i> Zapisz lokalnie</button>
        <button class="btn" onclick="copySms()"><i class="fa-solid fa-comment-sms"></i> Kopiuj SMS (wycena)</button>
      </div>

      <div class="notice" style="margin-top:12px;">
        <div class="section-title" style="margin:0 0 8px;">
          <h2 style="font-size:15px; margin:0; color:#bfdbfe">
            <i class="fa-solid fa-cloud-arrow-down"></i> Kosztorys z panelu (Supabase)
          </h2>
        </div>

        <textarea id="panelCosts" readonly placeholder="Tu pojawi się costs_text z panelu (jeśli istnieje)"></textarea>

        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="pullCostsFromPanel()">
            <i class="fa-solid fa-rotate"></i> Pobierz z panelu
          </button>
          <button class="btn btn-main" onclick="pushCostsToPanel()">
            <i class="fa-solid fa-cloud-arrow-up"></i> Zapisz do panelu (costs_text)
          </button>
          <button class="btn" onclick="openQrModal()">
            <i class="fa-solid fa-qrcode"></i> Skanuj QR
          </button>
        </div>

        <div id="syncNotice" class="notice" style="display:none; margin-top:10px;"></div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn btn-danger" onclick="clearLocal()"><i class="fa-solid fa-trash"></i> Wyczyść lokalne dane</button>
      </div>
    </div>
  </div>
</main>

<!-- MODAL QR -->
<div id="qrModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h3><i class="fa-solid fa-qrcode" style="color:var(--accent)"></i> Skanuj kod QR</h3>
      <button class="btn btn-danger" onclick="closeQrModal()"><i class="fa-solid fa-xmark"></i> Zamknij</button>
    </div>
    <div class="modal-body">
      <p style="margin-top:0; color:var(--muted); line-height:1.55">
        Kamera działa tylko na <b>HTTPS</b> i po udzieleniu zgody w przeglądarce.
        Jeśli telefon nie wspiera skanowania — wklej tekst/link z QR poniżej.
      </p>

      <video id="qrVideo" playsinline></video>
      <div id="qrErr" class="notice bad" style="display:none; margin-top:10px;"></div>

      <div class="row" style="margin-top:10px">
        <input id="qrText" placeholder="Wklej tu tekst/link z QR (fallback)" />
        <button class="btn btn-main" onclick="openFromQrText()"><i class="fa-solid fa-arrow-up-right-from-square"></i> Otwórz</button>
      </div>
    </div>
  </div>
</div>

<script>
  // =========================================
  // USTAWIENIA
  // =========================================
  const ORDER_TABLE = "orders";
  // supabaseClient jest z /supabaseClient.js
  const sb = window.supabaseClient;

  let order = null;
  let orderMatch = null;  // {field, value, key}
  let orderKey = null;    // localStorage key

  const $ = (id)=>document.getElementById(id);

  // =========================================
  // HELPERS (UI)
  // =========================================
  function showTop(msg, type="bad"){
    const el = $("topNotice");
    el.style.display = "block";
    el.className = "notice " + (type==="ok"?"ok":"bad");
    el.textContent = msg;
  }
  function hideTop(){
    const el = $("topNotice");
    el.style.display = "none";
    el.textContent = "";
  }
  function showSync(msg, type="ok"){
    const el = $("syncNotice");
    el.style.display = "block";
    el.className = "notice " + (type==="ok"?"ok":"bad");
    el.textContent = msg;
  }

  // =========================================
  // URL -> (code/id)
  // =========================================
  function parseQuery(){
    const sp = new URLSearchParams(location.search);
    const code = (sp.get("code") || "").trim();
    const id = (sp.get("id") || "").trim();

    if(code){
      return { field:"public_code", value: code, key:"code:"+code };
    }
    if(id){
      // jeśli wygląda jak UUID -> potraktuj jak public_code (u Ciebie QR często daje UUID jako kod)
      const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);
      if(isUuid){
        return { field:"public_code", value:id, key:"code:"+id };
      }
      return { field:"id", value: isNaN(Number(id)) ? id : Number(id), key:"id:"+id };
    }
    return null;
  }

  // =========================================
  // AUTH / LOAD ORDER
  // =========================================
  async function ensureLoggedIn(){
    try{
      const { data } = await sb.auth.getSession();
      return !!(data && data.session);
    }catch(e){
      return false;
    }
  }

  async function loadOrder(){
    hideTop();

    orderMatch = parseQuery();
    if(!orderMatch){
      showTop("Brak parametru w linku. Dodaj ?code=... (zalecane) albo ?id=...", "bad");
      $("panelBadge").className = "pill bad";
      $("panelBadge").innerHTML = '<i class="fa-solid fa-cloud"></i> panel: brak parametru';
      return;
    }
    orderKey = orderMatch.key;

    const ok = await ensureLoggedIn();
    if(!ok){
      showTop("Nie jesteś zalogowany w panelu. Otwórz najpierw login/panel i zaloguj się, potem wróć tutaj.", "bad");
      $("panelBadge").className = "pill bad";
      $("panelBadge").innerHTML = '<i class="fa-solid fa-cloud"></i> panel: brak loginu';
      return;
    }

    try{
      // WAŻNE: nie używamy issue_desc (u Ciebie kolumna nie istnieje -> 42703)
      const { data, error } = await sb
        .from(ORDER_TABLE)
        .select("id, public_code, customer_name, phone, bike_type, bike_brand, description, status, costs_text")
        .eq(orderMatch.field, orderMatch.value)
        .limit(1);

      if(error) throw error;

      if(!data || !data.length){
        showTop("Nie znaleziono zlecenia lub brak uprawnień.", "bad");
        $("panelBadge").className = "pill bad";
        $("panelBadge").innerHTML = '<i class="fa-solid fa-cloud"></i> panel: brak';
        return;
      }

      order = data[0];
      fillOrder(order);

      // panel costs
      $("panelCosts").value = (order.costs_text || "").trim();

      // lokalne dane
      loadLocal();

      // jeśli panel ma kosztorys, a lokalnie jest pusto -> wstaw jako start
      if(order.costs_text && !($("localCosts").value || "").trim()){
        $("localCosts").value = (order.costs_text || "").trim();
      }

      recalcSum();

      $("panelBadge").className = "pill ok";
      $("panelBadge").innerHTML = '<i class="fa-solid fa-cloud"></i> panel: OK';
      $("localBadge").className = "pill ok";
      $("localBadge").innerHTML = '<i class="fa-solid fa-shield-halved"></i> gotowe';

    }catch(e){
      console.error(e);
      showTop("Błąd ładowania zlecenia. Sprawdź konsolę.", "bad");
      $("panelBadge").className = "pill bad";
      $("panelBadge").innerHTML = '<i class="fa-solid fa-cloud"></i> panel: błąd';
    }
  }

  function fillOrder(o){
    const bike = [o.bike_type, o.bike_brand].filter(Boolean).join(" ");
    $("clientName").value = o.customer_name || "";
    $("clientPhone").value = o.phone || "";
    $("bikeName").value = bike || "";
    $("statusText").value = o.status || "";
    $("problemDesc").value = o.description || "";
  }

  // =========================================
  // LOCAL STORAGE
  // =========================================
  function localStorageKey(){
    return "jl_local_" + (orderKey || "unknown");
  }
  function getLocal(){
    try{
      const raw = localStorage.getItem(localStorageKey());
      return raw ? JSON.parse(raw) : { notes:"", costs:"", updated_at:null };
    }catch{
      return { notes:"", costs:"", updated_at:null };
    }
  }
  function setLocal(data){
    localStorage.setItem(localStorageKey(), JSON.stringify(data));
  }

  function saveLocal(){
    if(!orderKey){
      showSync("Brak klucza zlecenia w URL.", "bad");
      return;
    }
    const data = getLocal();
    data.notes = $("localNotes").value || "";
    data.costs = $("localCosts").value || "";
    data.updated_at = new Date().toISOString();
    setLocal(data);
    showSync("Zapisano lokalnie w telefonie.", "ok");
    $("localBadge").className = "pill ok";
    $("localBadge").innerHTML = '<i class="fa-solid fa-shield-halved"></i> zapisane';
  }

  function loadLocal(){
    if(!orderKey) return;
    const data = getLocal();
    $("localNotes").value = data.notes || "";
    $("localCosts").value = data.costs || $("localCosts").value || "";
  }

  function clearLocal(){
    if(!orderKey){
      showSync("Brak klucza zlecenia w URL.", "bad");
      return;
    }
    localStorage.removeItem(localStorageKey());
    $("localNotes").value = "";
    $("localCosts").value = "";
    recalcSum();
    showSync("Wyczyszczono lokalne dane.", "ok");
    $("localBadge").className = "pill";
    $("localBadge").innerHTML = '<i class="fa-solid fa-shield-halved"></i> lokalne dane';
  }

  // =========================================
  // KALKULATOR jak edit-order (sumowanie z tekstu)
  // =========================================
  function parseMoneyFromLine(line){
    // Wyłapuj liczby typu: 350, 350.50, 350,50
    const m = String(line||"")
      .replace(/\s+/g," ")
      .match(/(\d+(?:[.,]\d{1,2})?)/g);
    if(!m) return 0;

    // bierz ostatnią liczbę z linii (najczęściej cena na końcu)
    const last = m[m.length-1].replace(",",".");
    const val = Number(last);
    return isFinite(val) ? val : 0;
  }

  function recalcSum(){
    const text = $("localCosts").value || "";
    const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
    let total = 0;
    for(const ln of lines){
      total += parseMoneyFromLine(ln);
    }
    $("sumValue").textContent = total.toFixed(2) + " zł";
  }

  $("localCosts").addEventListener("input", recalcSum);

  function addLineToCosts(){
    const name = ($("itemName").value || "").trim();
    const price = ($("itemPrice").value || "").trim();
    const type = ($("itemType").value || "czynność").trim();

    if(!name){
      showSync("Wpisz nazwę pozycji.", "bad");
      return;
    }
    if(!price || !isFinite(Number(String(price).replace(",",".")))){
      showSync("Wpisz poprawną cenę.", "bad");
      return;
    }

    // format: "serwis kompletny 350 zł" (typ możesz dopisać jeśli chcesz)
    const line = `${name} ${price} zł`;

    const cur = $("localCosts").value || "";
    $("localCosts").value = (cur.trim() ? (cur.trimEnd() + "\n") : "") + line;

    $("itemName").value = "";
    $("itemPrice").value = "";
    recalcSum();
    showSync("Dodano do kosztorysu.", "ok");
  }

  // =========================================
  // PANEL: pull / push costs_text
  // =========================================
  async function pullCostsFromPanel(){
    if(!orderMatch){
      showSync("Brak parametru ?code/?id.", "bad");
      return;
    }
    try{
      const { data, error } = await sb
        .from(ORDER_TABLE)
        .select("costs_text")
        .eq(orderMatch.field, orderMatch.value)
        .limit(1);

      if(error) throw error;

      const costs = (data && data[0] && data[0].costs_text) ? data[0].costs_text : "";
      $("panelCosts").value = (costs || "").trim();

      // opcjonalnie: zaciągnij do lokalnego pola, jeśli lokalne puste
      if(!($("localCosts").value || "").trim() && costs){
        $("localCosts").value = (costs || "").trim();
        recalcSum();
      }

      showSync("Pobrano kosztorys z panelu.", "ok");
    }catch(e){
      console.error(e);
      showSync("Nie udało się pobrać z panelu. Sprawdź uprawnienia/RLS.", "bad");
    }
  }

  async function pushCostsToPanel(){
    if(!orderMatch){
      showSync("Brak parametru ?code/?id.", "bad");
      return;
    }
    const payloadText = ($("localCosts").value || "").trim();
    if(!payloadText){
      showSync("Kosztorys jest pusty — wpisz lub dodaj pozycje.", "bad");
      return;
    }

    try{
      const { error } = await sb
        .from(ORDER_TABLE)
        .update({ costs_text: payloadText })
        .eq(orderMatch.field, orderMatch.value);

      if(error) throw error;

      $("panelCosts").value = payloadText;
      showSync("Zapisano kosztorys do panelu (costs_text).", "ok");
    }catch(e){
      console.error(e);
      showSync("Nie udało się zapisać do panelu. Możliwe RLS/brak uprawnień.", "bad");
    }
  }

  // =========================================
  // SMS (copy)
  // =========================================
  async function copySms(){
    if(!order){
      showSync("Najpierw wczytaj zlecenie.", "bad");
      return;
    }
    const bike = $("bikeName").value || "rower";
    const costText = ($("localCosts").value || "").trim();
    const sumText = $("sumValue").textContent;

    const msg =
`JL Pro Bike Serwis
${bike}

Koszt (do wydania):
${costText || "-"}

SUMA: ${sumText}`;

    try{
      await navigator.clipboard.writeText(msg);
      showSync("Skopiowano treść SMS do schowka.", "ok");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = msg;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showSync("Skopiowano (tryb zgodności).", "ok");
    }
  }

  // =========================================
  // QR SCAN (BarcodeDetector)
  // =========================================
  let qrStream = null;
  let qrTimer = null;

  function openQrModal(){
    $("qrModal").classList.add("open");
    $("qrErr").style.display = "none";
    $("qrErr").textContent = "";
    startQrScan();
  }
  function closeQrModal(){
    stopQrScan();
    $("qrModal").classList.remove("open");
  }

  function extractCodeOrIdFromText(text){
    const t = String(text||"").trim();
    if(!t) return null;

    // URL -> wyciągnij parametry
    try{
      const url = new URL(t);
      const sp = url.searchParams;
      const code = (sp.get("code") || "").trim();
      const id = (sp.get("id") || "").trim();
      if(code) return { field:"public_code", value: code, key:"code:"+code };
      if(id){
        const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);
        if(isUuid) return { field:"public_code", value:id, key:"code:"+id };
        return { field:"id", value: isNaN(Number(id)) ? id : Number(id), key:"id:"+id };
      }
      return null;
    }catch(e){}

    // jeśli to sam kod: traktuj jako public_code
    return { field:"public_code", value:t, key:"code:"+t };
  }

  function openFromQrText(){
    const val = ($("qrText").value || "").trim();
    const match = extractCodeOrIdFromText(val);
    if(!match){
      $("qrErr").style.display = "block";
      $("qrErr").textContent = "Nie rozpoznano kodu/linku.";
      return;
    }
    // przeładuj stronę z parametrem
    const url = new URL(location.href);
    url.search = "";
    if(match.field === "public_code"){
      url.searchParams.set("code", match.value);
    }else{
      url.searchParams.set("id", match.value);
    }
    location.href = url.toString();
  }

  async function startQrScan(){
    // Na desktopie zwykle i tak nie chcesz skanować kamerą — ale zostawiamy.
    const video = $("qrVideo");

    if(!("mediaDevices" in navigator) || !navigator.mediaDevices.getUserMedia){
      showQrErr("Brak dostępu do kamery w tej przeglądarce.");
      return;
    }

    // BarcodeDetector działa w Chrome/Android. Jak brak -> fallback (wklej tekst)
    if(!("BarcodeDetector" in window)){
      showQrErr("Telefon/przeglądarka nie wspiera skanowania QR (BarcodeDetector). Wklej tekst/link poniżej.");
      return;
    }

    try{
      qrStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      video.srcObject = qrStream;
      await video.play();

      const detector = new BarcodeDetector({ formats: ["qr_code"] });

      qrTimer = setInterval(async ()=>{
        try{
          const barcodes = await detector.detect(video);
          if(barcodes && barcodes.length){
            const raw = barcodes[0].rawValue || "";
            $("qrText").value = raw;
            stopQrScan();
            // automatycznie otwórz
            openFromQrText();
          }
        }catch(e){
          // czasem rzuca błędy na pierwszych klatkach - ignorujemy
        }
      }, 350);

    }catch(e){
      console.error(e);
      showQrErr("Nie udało się uruchomić kamery. Sprawdź HTTPS i uprawnienia kamery.");
    }
  }

  function stopQrScan(){
    if(qrTimer){ clearInterval(qrTimer); qrTimer=null; }
    const video = $("qrVideo");
    try{ video.pause(); }catch(e){}
    video.srcObject = null;

    if(qrStream){
      try{
        qrStream.getTracks().forEach(t=>t.stop());
      }catch(e){}
      qrStream = null;
    }
  }

  function showQrErr(msg){
    $("qrErr").style.display = "block";
    $("qrErr").textContent = msg;
  }

  // =========================================
  // INIT
  // =========================================
  window.addEventListener("DOMContentLoaded", ()=>{
    // sumowanie live
    recalcSum();
    // wczytaj zlecenie z panelu
    loadOrder();
  });
</script>

</body>
</html>
