<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notatnik serwisanta (lokalnie) — JL Pro Bike Serwis</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ✅ kluczowe: absolutna ścieżka (działa z /panel/) -->
  <script src="/supabaseClient.js"></script>

  <style>
    :root{
      --accent:#2563eb;
      --accentHover:#1d4ed8;
      --bg:#020617;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --card:#0b1222;
      --border:rgba(255,255,255,0.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(37,99,235,.25), transparent 50%),
                  radial-gradient(800px 600px at 90% 10%, rgba(14,165,233,.18), transparent 45%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}

    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(2,6,23,.85), rgba(2,6,23,.65));
      border-bottom:1px solid var(--border);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
      color:#60a5fa;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .brand i{opacity:.9}
    .navActions{
      display:flex; align-items:center; gap:10px;
    }
    .pillBtn{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.04);
      border:1px solid var(--border);
      box-shadow:0 8px 22px rgba(0,0,0,.25);
    }
    .pillBtn:hover{border-color:rgba(255,255,255,.16)}
    .iconBtn{
      width:42px; height:42px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background:rgba(255,255,255,0.04);
      border:1px solid var(--border);
    }
    .iconBtn:hover{border-color:rgba(255,255,255,.18)}
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 40px;
    }
    .hero{
      padding:18px 18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius:22px;
      box-shadow: var(--shadow);
    }
    .hero h1{
      margin:0 0 6px;
      font-size:26px;
      letter-spacing:.2px;
    }
    .hero p{
      margin:0;
      color:var(--muted);
      line-height:1.35;
    }
    .badges{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.04);
      color:var(--muted);
      font-size:13px;
    }
    .badge.ok{color:#bbf7d0;border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.08)}
    .badge.warn{color:#fde68a;border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.08)}
    .badge.danger{color:#fecaca;border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.08)}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .card h2{
      margin:0 0 12px;
      font-size:16px;
      letter-spacing:.2px;
      color:#e2e8f0;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      margin:0 0 10px;
      line-height:1.35;
    }

    .field{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){
      .field{grid-template-columns:1fr}
    }
    .label{
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
    }
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(2,6,23,0.55);
      color:var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    textarea{min-height:120px; resize:vertical; line-height:1.35}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.18);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      cursor:pointer;
      transition:.15s;
      font-weight:700;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,0.18)}
    .btn-main{
      background:linear-gradient(180deg, rgba(37,99,235,.95), rgba(29,78,216,.95));
      border-color:rgba(37,99,235,.45);
    }
    .btn-main:hover{background:linear-gradient(180deg, rgba(29,78,216,.98), rgba(30,64,175,.98))}
    .btn-danger{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.28);
      color:#fecaca;
    }
    .btn-ghost{
      background:transparent;
      border-color:rgba(255,255,255,0.12);
      color:var(--muted);
    }

    .hr{
      height:1px;
      background:rgba(255,255,255,0.08);
      margin:14px 0;
    }

    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      max-width:min(520px, calc(100vw - 28px));
      background:rgba(2,6,23,.92);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      padding:12px 14px;
      display:none;
      gap:10px;
      align-items:flex-start;
      z-index:9999;
    }
    .toast.show{display:flex}
    .toast .ticon{margin-top:2px}
    .toast .tmsg{font-size:14px; line-height:1.35}
    .toast.ok{border-color:rgba(34,197,94,.25)}
    .toast.warn{border-color:rgba(245,158,11,.25)}
    .toast.danger{border-color:rgba(239,68,68,.25)}

    .sumLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-radius:16px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
      font-weight:800;
      letter-spacing:.2px;
    }

    .section-title{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      white-space:nowrap;
    }

    .qrModal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:99999;
    }
    .qrModal.show{display:flex}
    .qrBox{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(2,6,23,.96);
      box-shadow:0 30px 80px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .qrHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.10);
    }
    .qrHead .title{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .qrBody{padding:14px}
    video{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background:#000;
    }
    .qrHint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .qrWarn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,.22);
      background:rgba(239,68,68,.08);
      color:#fecaca;
      font-size:13px;
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="brand">
      <span>JL Pro Bike Serwis</span>
    </div>

    <div class="navActions">
      <a class="pillBtn" href="/panel/orders.html" title="Lista zleceń">
        <i class="fa-solid fa-list"></i> Zlecenia
      </a>
      <a class="iconBtn" href="/" title="Strona główna">
        <i class="fa-solid fa-house"></i>
      </a>
    </div>
  </header>

  <main class="wrap">
    <div class="hero">
      <h1><i class="fa-solid fa-calculator"></i> Notatnik serwisanta (lokalnie)</h1>
      <p>
        Pobiera zlecenie z panelu (po zalogowaniu), ale <b>wycena / notatki</b> zapisują się <b>tylko w telefonie</b>.
        Opcjonalnie możesz wysłać kosztorys do panelu (kolumna <code>costs_text</code>).
      </p>

      <div class="badges" id="badges">
        <div class="badge warn" id="badgeLocal"><i class="fa-solid fa-shield-halved"></i> lokalne dane</div>
        <div class="badge warn" id="badgePanel"><i class="fa-solid fa-cloud"></i> panel: brak</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: order read-only -->
      <section class="card">
        <h2><i class="fa-solid fa-clipboard-list"></i> Zlecenie</h2>
        <p class="sub" id="orderSub">Ładowanie zlecenia…</p>

        <div id="orderError" class="qrWarn" style="display:none;">
          <b>⚠️ Błąd ładowania zlecenia.</b> Sprawdź konsolę.
        </div>

        <div class="field" style="margin-top:12px;">
          <div>
            <div class="label">Klient</div>
            <input id="fCustomer" readonly />
          </div>
          <div>
            <div class="label">Telefon</div>
            <input id="fPhone" readonly />
          </div>
          <div>
            <div class="label">Rower</div>
            <input id="fBike" readonly />
          </div>
          <div>
            <div class="label">Status</div>
            <input id="fStatus" readonly />
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="label">Opis zlecenia (z panelu)</div>
          <textarea id="fIssue" readonly></textarea>
        </div>

        <div class="hr"></div>

        <div class="section-title" style="margin-top:0;">
          <span class="pill"><i class="fa-solid fa-qrcode"></i> QR</span>
          <button class="btn btn-ghost" onclick="openQrModal()"><i class="fa-solid fa-camera"></i> Skanuj QR</button>
        </div>

        <p class="sub" style="margin:10px 0 6px;">
          Jeśli nie działa skanowanie, wklej link/tekst z QR (np. link do <code>order-status.html?id=...</code>) i kliknij „Otwórz”.
        </p>

        <div class="row">
          <input id="qrText" placeholder="Wklej tu link/tekst QR…" />
          <button class="btn" onclick="openFromQrText()"><i class="fa-solid fa-arrow-right"></i> Otwórz</button>
        </div>
      </section>

      <!-- RIGHT: kalkulator (1 miejsce) -->
      <aside class="card">
        <h2><i class="fa-solid fa-pen-to-square"></i> Kalkulator</h2>

        <label class="sub" style="display:block;margin:0 0 6px;">Kalkulator (notatki + wycena — tylko telefon)</label>

        <textarea id="costText" placeholder="np.
czynność: serwis kompletny - 350 zł
część: linka przerzutki - 25 zł
czynność: regulacja przerzutki - 40 zł

Możesz też dopisywać zwykłe notatki (bez ceny)."></textarea>

        <div class="section-title" style="margin-top:12px;">
          <span class="pill"><i class="fa-solid fa-list"></i> Dodaj pozycję (szybko)</span>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="addName" placeholder="np. regulacja przerzutki / klocki ham." />
          <input id="addPrice" inputmode="decimal" placeholder="cena (zł)" />
          <select id="addType">
            <option value="czynność">czynność</option>
            <option value="część">część</option>
          </select>
          <button class="btn btn-main" onclick="appendCostLine()"><i class="fa-solid fa-plus"></i> Dodaj</button>
        </div>

        <div class="sumLine" style="margin-top:12px;">
          <span><i class="fa-solid fa-calculator"></i> Suma</span>
          <span id="sumValue">0 zł</span>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between;">
          <button class="btn" onclick="saveLocal()"><i class="fa-solid fa-floppy-disk"></i> Zapisz lokalnie</button>
          <button class="btn" onclick="copySms()"><i class="fa-solid fa-comment-sms"></i> Kopiuj SMS (wycena)</button>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;">
          <button class="btn" onclick="pullCostsFromPanel()"><i class="fa-solid fa-cloud-arrow-down"></i> Pobierz z panelu</button>
          <button class="btn btn-main" onclick="pushCostsToPanel()"><i class="fa-solid fa-cloud-arrow-up"></i> Wyślij do panelu</button>
        </div>

        <div class="row" style="margin-top:10px; justify-content:space-between;">
          <button class="btn btn-danger" onclick="clearLocal()"><i class="fa-solid fa-trash"></i> Wyczyść lokalne dane</button>
        </div>
      </aside>
    </div>
  </main>

  <!-- QR modal -->
  <div class="qrModal" id="qrModal" aria-hidden="true">
    <div class="qrBox">
      <div class="qrHead">
        <div class="title"><i class="fa-solid fa-qrcode"></i> Skanuj kod QR</div>
        <button class="btn btn-danger" onclick="closeQrModal()"><i class="fa-solid fa-xmark"></i> Zamknij</button>
      </div>
      <div class="qrBody">
        <video id="qrVideo" playsinline></video>
        <div class="qrHint">
          Jeśli QR zawiera link do statusu (np. <code>.../order-status.html?id=123</code>), zostanie automatycznie otwarty.
          <br>Uwaga: kamera działa tylko na HTTPS i po udzieleniu zgody w przeglądarce.
        </div>
        <div class="qrWarn" id="qrWarn" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="ticon" id="toastIcon">✅</div>
    <div class="tmsg" id="toastMsg">OK</div>
  </div>

<script>
  // ==============================
  // Helpers
  // ==============================
  const $ = (id)=>document.getElementById(id);

  function toast(msg, type="ok"){
    const el = $("toast");
    const icon = $("toastIcon");
    const m = $("toastMsg");
    el.className = "toast show " + (type||"");
    icon.textContent = type==="ok" ? "✅" : type==="warn" ? "⚠️" : "⛔";
    m.textContent = msg;
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>el.classList.remove("show"), 2200);
  }

  function formatMoney(n){
    try{
      return new Intl.NumberFormat("pl-PL", {minimumFractionDigits:0, maximumFractionDigits:2}).format(n);
    }catch(e){
      return String(Math.round(n*100)/100);
    }
  }

  function setLocalBadge(has){
    const b = $("badgeLocal");
    b.className = "badge " + (has ? "ok" : "warn");
  }
  function setPanelBadge(state){
    const b = $("badgePanel");
    if(state==="ok") b.className="badge ok";
    else if(state==="danger") b.className="badge danger";
    else b.className="badge warn";
  }

  // ==============================
  // Params
  // ==============================
  const url = new URL(location.href);
  const orderId = url.searchParams.get("id");

  let customerName="", phone="", bikeType="", status="", issueDesc="";

  // ==============================
  // Load order (read-only)
  // ==============================
  async function loadOrder(){
    if(!orderId){
      $("orderSub").textContent = "Brak ID w URL (np. ?id=...).";
      $("orderError").style.display = "";
      setPanelBadge("danger");
      return;
    }
    try{
      const { data, error } = await supabaseClient
        .from("orders")
        .select("id, customer_name, phone, bike_type, status, issue_desc")
        .eq("id", orderId)
        .single();

      if(error) throw error;

      customerName = data.customer_name || "";
      phone = data.phone || "";
      bikeType = data.bike_type || "";
      status = data.status || "";
      issueDesc = data.issue_desc || "";

      $("fCustomer").value = customerName;
      $("fPhone").value = phone;
      $("fBike").value = bikeType;
      $("fStatus").value = status;
      $("fIssue").value = issueDesc;

      $("orderSub").textContent = "Zlecenie z panelu (bez edycji).";
      $("orderError").style.display = "none";
      setPanelBadge("ok");
    }catch(e){
      console.error(e);
      $("orderSub").textContent = "Błąd ładowania.";
      $("orderError").style.display = "";
      setPanelBadge("danger");
    }
  }

  // ==============================
  // Local: jeden kalkulator (notatki + wycena) — tylko w telefonie
  // ==============================
  const COST_KEY = `jl_local_costText_${orderId}`;

  const costTextEl = $("costText");
  const addNameEl  = $("addName");
  const addPriceEl = $("addPrice");
  const addTypeEl  = $("addType");
  const sumEl      = $("sumValue");

  function normalizePriceToNumber(raw){
    if(!raw) return 0;
    const m = String(raw).replace(/\s/g,'').replace('zł','').match(/-?\d+(?:[.,]\d+)?/);
    if(!m) return 0;
    return parseFloat(m[0].replace(',','.')) || 0;
  }

  function sumFromText(text){
    const t = String(text || '');
    const withZl = [...t.matchAll(/(-?\d+(?:[.,]\d+)?)\s*zł/gi)].map(x=>normalizePriceToNumber(x[1]));
    if(withZl.length) return withZl.reduce((a,b)=>a+b,0);

    const endNums = [...t.matchAll(/(-?\d+(?:[.,]\d+)?)\s*$/gm)].map(x=>normalizePriceToNumber(x[1]));
    return endNums.reduce((a,b)=>a+b,0);
  }

  function updateSum(){
    const s = sumFromText(costTextEl.value);
    sumEl.textContent = `${formatMoney(s)} zł`;
    return s;
  }

  function saveCostTextSilent(){
    localStorage.setItem(COST_KEY, costTextEl.value || "");
    updateSum();
    setLocalBadge(true);
  }

  function loadCostText(){
    const t = localStorage.getItem(COST_KEY) || "";
    costTextEl.value = t;
    updateSum();
  }

  costTextEl.addEventListener("input", ()=>{
    saveCostTextSilent();
  });

  function appendCostLine(){
    const name = (addNameEl.value || "").trim();
    const priceRaw = (addPriceEl.value || "").trim();
    const type = addTypeEl.value || "czynność";
    if(!name && !priceRaw) return;

    const price = normalizePriceToNumber(priceRaw);
    let line = "";
    if(name && priceRaw){
      line = `${type}: ${name} - ${formatMoney(price)} zł`;
    }else if(name){
      line = `${type}: ${name}`;
    }else{
      line = `${type}: ${formatMoney(price)} zł`;
    }

    const cur = costTextEl.value ? costTextEl.value.trimEnd() + "\n" : "";
    costTextEl.value = cur + line + "\n";
    addNameEl.value = "";
    addPriceEl.value = "";
    saveCostTextSilent();
    toast("Dodano pozycję do kalkulatora.", "ok");
  }

  function saveLocal(){
    saveCostTextSilent();
    toast("Zapisano lokalnie.", "ok");
  }

  async function copySms(){
    const sum = updateSum();
    const orderLine = [
      bikeType ? `Rower: ${bikeType}` : "",
      customerName ? `Klient: ${customerName}` : "",
      phone ? `Tel: ${phone}` : ""
    ].filter(Boolean).join(" | ");

    const body = (costTextEl.value || "").trim();
    const msg = [
      "JL Pro Bike Serwis — wycena",
      orderLine,
      body ? "\n" + body : "",
      `\nSuma: ${formatMoney(sum)} zł`
    ].join("\n");

    try{
      await navigator.clipboard.writeText(msg);
      toast("Skopiowano do schowka (wklej do SMS).", "ok");
    }catch(e){
      toast("Nie mogę skopiować — włącz uprawnienia schowka / użyj Kopiuj ręcznie.", "warn");
    }
  }

  function clearLocal(){
    if(!confirm("Usunąć lokalne dane (kalkulator) dla tego zlecenia z telefonu?")) return;
    localStorage.removeItem(COST_KEY);
    loadCostText();
    toast("Usunięto lokalne dane.", "ok");
  }

  async function pullCostsFromPanel(){
    try{
      const { data, error } = await supabaseClient
        .from("orders")
        .select("costs_text")
        .eq("id", orderId)
        .single();
      if(error) throw error;

      const t = (data && data.costs_text) ? String(data.costs_text) : "";
      if(t){
        costTextEl.value = t;
        saveCostTextSilent();
        toast("Pobrano kosztorys z panelu do telefonu.", "ok");
      }else{
        toast("W panelu brak kosztorysu (costs_text jest puste).", "warn");
      }
    }catch(e){
      console.error(e);
      toast("Nie udało się pobrać z panelu. Sprawdź konsolę / logowanie.", "danger");
    }
  }

  async function pushCostsToPanel(){
    try{
      const { data: sess } = await supabaseClient.auth.getSession();
      if(!sess || !sess.session){
        toast("Zaloguj się w panelu (login.html), a potem wróć tutaj.", "warn");
        return;
      }

      const payload = { costs_text: (costTextEl.value || "").trim() };
      const { error } = await supabaseClient
        .from("orders")
        .update(payload)
        .eq("id", orderId);

      if(error) throw error;
      toast("Wysłano kosztorys do panelu (costs_text).", "ok");
    }catch(e){
      console.error(e);
      toast("Nie udało się wysłać do panelu. Sprawdź konsolę / RLS.", "danger");
    }
  }

  // ==============================
  // QR scan (kamera)
  // ==============================
  let qrStream = null;
  let qrTimer = null;

  function openQrModal(){
    $("qrModal").classList.add("show");
    startQrCamera();
  }
  function closeQrModal(){
    $("qrModal").classList.remove("show");
    stopQrCamera();
  }

  async function startQrCamera(){
    $("qrWarn").style.display="none";
    try{
      const constraints = { video: { facingMode: "environment" }, audio:false };
      qrStream = await navigator.mediaDevices.getUserMedia(constraints);
      const v = $("qrVideo");
      v.srcObject = qrStream;
      await v.play();

      // proste wykrywanie QR: jeśli masz bibliotekę, podepnij ją tu.
      // (Zostawiamy minimalnie: pokazuje kamerę, a QR możesz wkleić ręcznie w polu.)
      qrWarn("Kamera działa. Jeśli QR się nie czyta, wklej link/tekst w pole poniżej.", false);

    }catch(e){
      console.error(e);
      qrWarn("Brak dostępu do kamery. Sprawdź: HTTPS, zgoda na kamerę, oraz czy nie otwierasz w przeglądarce FB/Messenger.", true);
    }
  }

  function stopQrCamera(){
    try{
      if(qrTimer) clearInterval(qrTimer);
      qrTimer = null;
      if(qrStream){
        qrStream.getTracks().forEach(t=>t.stop());
        qrStream = null;
      }
      const v = $("qrVideo");
      v.pause();
      v.srcObject = null;
    }catch(e){}
  }

  function qrWarn(msg, danger){
    const el = $("qrWarn");
    el.style.display="";
    el.textContent = msg;
    el.style.borderColor = danger ? "rgba(239,68,68,.22)" : "rgba(245,158,11,.22)";
    el.style.background = danger ? "rgba(239,68,68,.08)" : "rgba(245,158,11,.08)";
    el.style.color = danger ? "#fecaca" : "#fde68a";
  }

  function openFromQrText(){
    const t = ($("qrText").value || "").trim();
    if(!t) return;
    try{
      const u = new URL(t, location.origin);
      // jeśli jest to link do statusu, wyciągnij id
      const id = u.searchParams.get("id");
      if(id){
        location.href = `/panel/order-local.html?id=${encodeURIComponent(id)}`;
        return;
      }
      // jeśli to link bez id — po prostu przejdź
      location.href = u.href;
    }catch(e){
      // nie URL — spróbuj znaleźć id w tekście
      const m = t.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i);
      if(m){
        location.href = `/panel/order-local.html?id=${encodeURIComponent(m[0])}`;
      }else{
        toast("Nie rozpoznano QR (wklej link z ?id=... albo UUID).", "warn");
      }
    }
  }

  // ==============================
  // Init
  // ==============================
  (async ()=>{
    setPanelBadge("warn");
    setLocalBadge(!!localStorage.getItem(COST_KEY));
    loadCostText();
    await loadOrder();
  })();
</script>

</body>
</html>
