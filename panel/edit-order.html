<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Edycja zlecenia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{background:#020617;color:#e5e7eb;font-family:system-ui;margin:0}
.wrapper{max-width:1100px;margin:auto;padding:16px}
.card{background:#0f172a;border-radius:16px;padding:16px;margin-bottom:16px}
.card-title{display:flex;justify-content:space-between;align-items:center}
.badge{font-size:12px;opacity:.6}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
label{display:block;margin-top:10px;font-size:13px;opacity:.8}
input,textarea,select{width:100%;padding:10px;border-radius:10px;border:none;background:#020617;color:#fff}
textarea{min-height:90px}
.sum{margin-top:10px;font-weight:bold}
.btn{padding:10px 14px;border-radius:12px;border:none;cursor:pointer}
.btn.small{font-size:13px}
.btn.warn{background:#f59e0b;color:#000}
.btn.neutral{background:#1e293b;color:#fff}
.btn.save{background:#2563eb;color:#fff;width:100%}
.photoBar{margin-top:12px}
.photoTop{display:flex;justify-content:space-between;align-items:center}
.help{font-size:12px;opacity:.6;margin-top:6px}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
</style>
</head>

<body>
<div class="wrapper">

<header>
  <h1><i class="fa-solid fa-pen-to-square"></i> Edycja zlecenia</h1>
</header>

<div class="grid">

<!-- LEWA -->
<div class="card">
  <div class="card-title">
    <h2>Zlecenie</h2>
    <span class="badge">Dane klienta</span>
  </div>

  <label>Status</label>
  <select id="status">
    <option>oczekujące</option>
    <option>nowe</option>
    <option>w trakcie</option>
    <option>gotowe</option>
    <option>wydano</option>
  </select>

  <label>Klient</label>
  <input id="customer">

  <label>Telefon</label>
  <input id="phone">

  <label>Rower</label>
  <input id="bike">

  <label>Opis</label>
  <textarea id="note"></textarea>
</div>

<!-- PRAWA -->
<div class="card">
  <div class="card-title">
    <h2>Kosztorys</h2>
    <span class="badge">SMS + Galeria</span>
  </div>

  <label>Koszt</label>
  <textarea id="costText"></textarea>

  <div class="sum">SUMA: <span id="sum">0.00</span> zł</div>

  <div class="photoBar">
    <div class="photoTop">
      <div>
        <i class="fa-solid fa-camera"></i>
        Zdjęcia: <b id="photoCount">0</b>
      </div>
      <button class="btn small neutral" onclick="openStaffGallery()">Galeria</button>
    </div>

    <div class="row">
      <button class="btn small warn" onclick="smsPro()">
        <i class="fa-solid fa-paper-plane"></i> SMS PRO
      </button>
    </div>

    <div class="help">
      Klient dostaje link do galerii publicznej (bez logowania)
    </div>
  </div>
</div>

</div>

<div class="actions">
  <button class="btn save" onclick="save()">Zapisz zmiany</button>
</div>

</div>

<script>
/* ===== KONFIG ===== */
const SUPABASE_URL = "https://mzgxvlltlcrvzmtswzql.supabase.co";
const SUPABASE_KEY = "TU_WSTAW_PUBLISHABLE_KEY";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const id = new URLSearchParams(location.search).get("id");

let publicCode = "";
let currentTotal = 0;

/* ===== ELEMENTY ===== */
const status = document.getElementById("status");
const customer = document.getElementById("customer");
const phone = document.getElementById("phone");
const bike = document.getElementById("bike");
const note = document.getElementById("note");
const costText = document.getElementById("costText");
const sumEl = document.getElementById("sum");
const photoCountEl = document.getElementById("photoCount");

/* ===== UTIL ===== */
function normalizePhoneToPL48(v){
  const d = (v||"").replace(/\D/g,"");
  if(d.length===9) return "48"+d;
  if(d.startsWith("48") && d.length===11) return d;
  return "";
}

function calcSum(){
  let s=0;
  (costText.value||"").split("\n").forEach(l=>{
    const m=l.match(/(\d+[.,]?\d*)$/);
    if(m) s+=parseFloat(m[1].replace(",","."))||0;
  });
  currentTotal=s;
  sumEl.textContent=s.toFixed(2);
}

/* ===== PUBLIC CODE ===== */
async function ensurePublicCode(){
  if(publicCode) return publicCode;

  const code = crypto.randomUUID();
  await supabaseClient.from("orders").update({ public_code: code }).eq("id", id);
  publicCode = code;
  return code;
}

async function getPublicGalleryUrl(){
  const code = await ensurePublicCode();
  return `${location.origin}/order-photos-public.html?code=${code}`;
}

/* ===== GALERIA ===== */
function openStaffGallery(){
  location.href = `/panel/order-photos.html?id=${id}`;
}

/* ===== SMS PRO ===== */
async function smsPro(){
  calcSum();
  const to = normalizePhoneToPL48(phone.value);
  const gallery = await getPublicGalleryUrl();

  const body =
`JL Pro Bike Serwis
Twój kosztorys:
${costText.value || "(brak pozycji)"}

Suma: ${currentTotal.toFixed(2)} zł
Zdjęcia:
${gallery}`;

  await navigator.clipboard.writeText(body);

  if(!to){
    alert("SMS skopiowany. Brak numeru telefonu.");
    return;
  }

  const sep = /iPhone|iPad/.test(navigator.userAgent) ? "&" : "?";
  location.href = `sms:${to}${sep}body=${encodeURIComponent(body)}`;
}

/* ===== LOAD / SAVE ===== */
async function load(){
  const { data } = await supabaseClient.from("orders").select("*").eq("id", id).single();
  if(!data) return;

  status.value=data.status||"";
  customer.value=data.customer_name||"";
  phone.value=data.phone||"";
  bike.value=data.bike_type||"";
  note.value=data.description||"";
  costText.value=data.cost_text||"";
  publicCode=data.public_code||"";

  calcSum();
}

async function save(){
  calcSum();
  await supabaseClient.from("orders").update({
    status:status.value,
    customer_name:customer.value,
    phone:phone.value,
    bike_type:bike.value,
    description:note.value,
    cost_text:costText.value,
    total_cost:currentTotal
  }).eq("id", id);

  alert("Zapisano ✅");
}

load();
</script>
</body>
</html>
